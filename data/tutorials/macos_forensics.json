{
  "id": "macos_forensics",
  "title": "macOS Forensics Deep Dive",
  "description": "Comprehensive macOS forensic analysis covering APFS, system artifacts, application data, user activity traces, and macOS-specific evidence locations.",
  "type": "tutorial",
  "steps": [
    {
      "id": "apfs_filesystem",
      "title": "APFS Filesystem Forensics",
      "content": "OBJECTIVE: Understand APFS filesystem structure and forensic implications including snapshots, encryption, and cloning.\n\nACADEMIC BACKGROUND:\nApple File System (APFS) replaced HFS+ in 2017, introducing native encryption, snapshots, space sharing, and cloning. Forensic examiners must understand APFS-specific structures including containers, volumes, and the new allocation scheme to effectively analyze modern Macs.\n\nAPFS ARCHITECTURE:\n\n1. APFS STRUCTURE:\n   ```\n   APFS Container Structure:\n   \n   Container (GPT Partition)\n   ├── Container Superblock\n   ├── Checkpoint Area\n   ├── Space Manager\n   └── Volumes (up to 100)\n       ├── Macintosh HD (System)\n       ├── Macintosh HD - Data (User Data)\n       ├── Preboot\n       ├── Recovery\n       └── VM (Virtual Memory)\n   \n   Key APFS Features:\n   | Feature | Forensic Implication |\n   |---------|---------------------|\n   | Copy-on-Write | Original data preserved until overwritten |\n   | Snapshots | Point-in-time recovery, historical data |\n   | Cloning | Files may share blocks |\n   | Encryption | Native encryption, T2/M1 secure enclave |\n   | Space Sharing | Multiple volumes share free space |\n   | Sparse Files | Large files may not occupy full space |\n   \n   Volume Roles:\n   | Volume | Content | Mounted At |\n   |--------|---------|------------|\n   | System | OS, Apps | / (read-only) |\n   | Data | User data, configs | /System/Volumes/Data |\n   | Preboot | Boot files | /System/Volumes/Preboot |\n   | Recovery | Recovery OS | /System/Volumes/Recovery |\n   | VM | Swap files | /System/Volumes/VM |\n   ```\n\n2. APFS ACQUISITION:\n   ```bash\n   # Target Disk Mode Acquisition (Intel Macs)\n   # Boot with T held, connect via Thunderbolt\n   # Target appears as external drive\n   \n   # Modern Mac Acquisition Challenges:\n   # - T2/M1 chip encryption\n   # - Secure Boot\n   # - No Target Disk Mode on Apple Silicon\n   # - MDM enrollment checks\n   \n   # Software Acquisition Methods:\n   \n   # 1. Using dd (if mounted)\n   sudo dd if=/dev/disk0 of=/path/to/image.raw bs=4M status=progress\n   \n   # 2. Using APFS-aware tools\n   # Cellebrite, Magnet ACQUIRE, MacQuisition\n   \n   # 3. Local imaging\n   sudo asr restore --source /dev/disk0 --target /path/to/image.dmg --erase\n   \n   # Listing APFS Information:\n   diskutil list\n   diskutil apfs list\n   \n   # Example output:\n   # Container disk1 (APFS Container)\n   #   Physical Store disk0s2\n   #   Capacity: 500 GB\n   #   Volumes:\n   #     disk1s1 - Macintosh HD\n   #     disk1s2 - Preboot\n   #     disk1s3 - Recovery\n   #     disk1s4 - VM\n   #     disk1s5 - Macintosh HD - Data\n   \n   # APFS Snapshots\n   tmutil listlocalsnapshots /\n   # Mounts: com.apple.TimeMachine.2024-03-15-120000.local\n   \n   # Mount a snapshot\n   mkdir /tmp/snapshot\n   mount_apfs -s com.apple.TimeMachine.2024-03-15 /dev/disk1s1 /tmp/snapshot\n   ```\n\n3. APFS FORENSIC ARTIFACTS:\n   ```bash\n   # APFS Metadata Locations:\n   \n   # Container Superblock\n   # - Volume information\n   # - Encryption state\n   # - Creation timestamps\n   \n   # Object Map (omap)\n   # - Tracks all filesystem objects\n   # - Historical versions available\n   \n   # Extent Reference Tree\n   # - Tracks block allocation\n   # - Identifies shared blocks (clones)\n   \n   # Snapshot Metadata\n   # - Point-in-time filesystem state\n   # - Can recover deleted files\n   \n   # Analyzing APFS with libapfs:\n   # Build and install libapfs\n   apfsinfo /dev/disk0s2\n   \n   # List volumes\n   apfsinfo -v /dev/disk0s2\n   \n   # Extract specific files\n   apfsmount /dev/disk0s2 /mnt/apfs/\n   ```\n\n4. ENCRYPTION CONSIDERATIONS:\n   ```\n   APFS Encryption Types:\n   \n   1. Software Encryption (FileVault)\n      - Full volume encryption\n      - Password or recovery key required\n      - Keys stored in /var/db/SystemKey\n   \n   2. Hardware Encryption (T2/M1)\n      - Always-on encryption\n      - Keys in Secure Enclave\n      - Cannot image without authentication\n   \n   Acquisition Strategies:\n   \n   | Mac Type | Approach |\n   |----------|----------|\n   | Pre-T2 Intel | Target Disk Mode, dd |\n   | T2 Intel | Live acquisition with user password |\n   | M1/M2/M3 | Live acquisition with user password |\n   | MDM Enrolled | May require MDM credentials |\n   \n   FileVault Recovery:\n   # Recovery key locations:\n   # - User-provided recovery key\n   # - Institutional recovery key (MDM)\n   # - iCloud recovery (Apple escrow)\n   \n   # Check FileVault status\n   fdesetup status\n   \n   # List FileVault users\n   fdesetup list\n   ```\n\nAPFS ANALYSIS CHECKLIST:\n```\nAPFS Forensic Examination:\n\n[ ] Container Analysis\n    [ ] Identify container and volumes\n    [ ] Document encryption state\n    [ ] Enumerate snapshots\n    \n[ ] Volume Examination\n    [ ] System volume analysis\n    [ ] Data volume analysis\n    [ ] Preboot examination\n    \n[ ] Snapshot Recovery\n    [ ] List all snapshots\n    [ ] Mount relevant snapshots\n    [ ] Compare to current state\n    \n[ ] Deleted File Recovery\n    [ ] Check unallocated space\n    [ ] Analyze snapshot deltas\n    [ ] Examine journal (if accessible)\n```\n\nKEY FORENSIC IMPLICATIONS:\n- Snapshots preserve historical state\n- Encryption may block acquisition\n- System/Data volume split affects analysis\n- Clone blocks may confuse file recovery\n\nFURTHER READING:\n- Apple APFS Reference (developer.apple.com)\n- \"Mac OS X and iOS Internals\" by Levin\n- libapfs documentation",
      "tags": ["forensics", "macos", "apfs", "filesystem", "dfir"],
      "related_tools": ["exiftool", "binwalk", "foremost", "strings"]
    },
    {
      "id": "macos_system_artifacts",
      "title": "macOS System Artifacts",
      "content": "OBJECTIVE: Identify and analyze key macOS system artifacts for forensic investigations including logs, databases, and configuration files.\n\nACADEMIC BACKGROUND:\nmacOS stores extensive system information in property lists (plists), SQLite databases, and unified logs. These artifacts provide evidence of system configuration, installed software, network activity, and user actions. Modern macOS uses the Unified Logging System introduced in macOS 10.12.\n\nSYSTEM ARTIFACTS:\n\n1. SYSTEM CONFIGURATION:\n   ```bash\n   # System Information Files:\n   \n   /Library/Preferences/SystemConfiguration/\n   ├── preferences.plist     # Network settings\n   ├── NetworkInterfaces.plist  # Interface configuration\n   └── com.apple.airport.preferences.plist  # WiFi config\n   \n   # System Profile\n   /Library/Preferences/com.apple.loginwindow.plist\n   # - Last logged-in user\n   # - Auto-login settings\n   \n   # Read plist files\n   plutil -p /Library/Preferences/com.apple.loginwindow.plist\n   # or\n   defaults read /Library/Preferences/com.apple.loginwindow\n   \n   # System Version\n   /System/Library/CoreServices/SystemVersion.plist\n   plutil -p /System/Library/CoreServices/SystemVersion.plist\n   # Output: ProductVersion: \"14.4\", BuildVersion: \"23E214\"\n   \n   # Installed Software\n   /Library/Receipts/InstallHistory.plist\n   plutil -p /Library/Receipts/InstallHistory.plist\n   # Shows: install date, package name, version\n   \n   # Gatekeeper\n   /var/db/SystemPolicy-prefs.plist\n   # Application execution policy\n   ```\n\n2. UNIFIED LOGGING:\n   ```bash\n   # Unified Log System (introduced macOS 10.12)\n   \n   # Log Locations:\n   /var/db/diagnostics/     # Log data files\n   /var/db/uuidtext/        # UUID text mappings\n   \n   # Live log viewing\n   log show --predicate 'processName == \"loginwindow\"' --last 1h\n   \n   # Filter by subsystem\n   log show --predicate 'subsystem == \"com.apple.securityd\"' --last 1d\n   \n   # Filter by category\n   log show --predicate 'category == \"connection\"' --last 1h\n   \n   # Export logs to file\n   log collect --output ~/Desktop/system_logs.logarchive\n   \n   # Forensic log extraction (from image)\n   log show --archive /path/to/system.logarchive \\\n            --predicate 'eventMessage CONTAINS \"sudo\"'\n   \n   # Useful forensic queries:\n   \n   # SSH connections\n   log show --predicate 'process == \"sshd\"' --last 7d\n   \n   # User authentication\n   log show --predicate 'subsystem == \"com.apple.opendirectoryd\"' --last 1d\n   \n   # Process execution\n   log show --predicate 'eventMessage CONTAINS \"execve\"' --last 1h\n   \n   # Network connections\n   log show --predicate 'subsystem == \"com.apple.network\"' --last 1d\n   ```\n\n3. SECURITY ARTIFACTS:\n   ```bash\n   # Keychain Files:\n   ~/Library/Keychains/\n   ├── login.keychain-db     # User passwords, certificates\n   └── [UUID]/               # iCloud Keychain sync\n   \n   /Library/Keychains/\n   └── System.keychain       # System-wide secrets\n   \n   # Analyze keychain (requires password)\n   security dump-keychain -d login.keychain-db\n   \n   # Authorization Database\n   /var/db/auth.db\n   sqlite3 /var/db/auth.db \"SELECT * FROM rules;\"\n   \n   # TCC Database (Privacy permissions)\n   ~/Library/Application Support/com.apple.TCC/TCC.db\n   /Library/Application Support/com.apple.TCC/TCC.db\n   \n   sqlite3 ~/Library/Application\\ Support/com.apple.TCC/TCC.db \\\n           \"SELECT * FROM access;\"\n   # Shows: which apps have camera, microphone, disk access\n   \n   # Gatekeeper Execution Log\n   /var/db/SystemPolicy\n   sqlite3 /var/db/SystemPolicy \"SELECT * FROM authority;\"\n   \n   # Quarantine Events\n   ~/Library/Preferences/com.apple.LaunchServices.QuarantineEventsV2\n   sqlite3 ~/Library/Preferences/com.apple.LaunchServices.QuarantineEventsV2 \\\n           \"SELECT datetime(LSQuarantineTimeStamp + 978307200, 'unixepoch'), \\\n                   LSQuarantineAgentName, LSQuarantineDataURLString \\\n            FROM LSQuarantineEvent;\"\n   # Shows: downloaded files, download time, source URL\n   ```\n\n4. NETWORK ARTIFACTS:\n   ```bash\n   # WiFi Connection History:\n   /Library/Preferences/SystemConfiguration/com.apple.airport.preferences.plist\n   plutil -p /Library/Preferences/SystemConfiguration/com.apple.airport.preferences.plist\n   # Shows: SSIDs, connection timestamps, security type\n   \n   # Known Networks\n   /Library/Preferences/com.apple.wifi.known-networks.plist\n   \n   # DHCP Leases\n   /var/db/dhcpclient/leases/\n   \n   # DNS Cache (live)\n   sudo dscacheutil -cachedump -entries DNS\n   \n   # Network Interfaces\n   /Library/Preferences/SystemConfiguration/NetworkInterfaces.plist\n   \n   # Firewall Configuration\n   /Library/Preferences/com.apple.alf.plist\n   plutil -p /Library/Preferences/com.apple.alf.plist\n   \n   # Firewall Application Rules\n   /Library/Preferences/com.apple.alf.plist\n   # Look for \"applications\" key - shows allowed/denied apps\n   ```\n\n5. STARTUP AND PERSISTENCE:\n   ```bash\n   # Launch Agents and Daemons:\n   \n   # System-wide daemons\n   /Library/LaunchDaemons/\n   /System/Library/LaunchDaemons/\n   \n   # System-wide agents\n   /Library/LaunchAgents/\n   /System/Library/LaunchAgents/\n   \n   # User agents\n   ~/Library/LaunchAgents/\n   \n   # List all launch items\n   launchctl list\n   \n   # Analyze plist for suspicious entries\n   for plist in /Library/LaunchDaemons/*.plist; do\n       plutil -p \"$plist\" | grep -E \"Program|Arguments\"\n   done\n   \n   # Login Items\n   ~/Library/Application Support/com.apple.backgroundtaskmanagementagent/backgrounditems.btm\n   sfltool dumpbtm\n   \n   # Startup Items (legacy)\n   /Library/StartupItems/\n   \n   # Cron Jobs\n   /var/at/tabs/\n   crontab -l\n   \n   # Periodic Scripts\n   /etc/periodic/daily/\n   /etc/periodic/weekly/\n   /etc/periodic/monthly/\n   ```\n\n6. TIME ARTIFACTS:\n   ```bash\n   # System Timestamps:\n   \n   # Boot Time\n   sysctl kern.boottime\n   # Output: { sec = 1710504000, usec = 0 }\n   \n   # Last Shutdown\n   last shutdown\n   \n   # Sleep/Wake History\n   pmset -g log | grep -E \"Wake|Sleep\"\n   \n   # File System Timestamps (APFS)\n   # - creation time (birth time)\n   # - modification time\n   # - access time\n   # - change time (metadata change)\n   \n   stat -x /path/to/file\n   # Or with GetFileInfo\n   GetFileInfo /path/to/file\n   \n   # Extended Attributes (may contain dates)\n   xattr -l /path/to/file\n   # com.apple.metadata:kMDItemDownloadedDate\n   # com.apple.quarantine\n   ```\n\nSYSTEM ARTIFACT LOCATIONS:\n```\nKey Forensic Locations:\n\n/var/db/\n├── dslocal/              # Local directory service\n├── SystemPolicy          # Gatekeeper database\n├── auth.db               # Authorization database\n└── diagnostics/          # Unified logs\n\n/Library/Preferences/\n├── SystemConfiguration/  # Network settings\n├── com.apple.alf.plist   # Firewall config\n└── com.apple.loginwindow.plist  # Login settings\n\n/Library/\n├── LaunchDaemons/        # System services\n├── LaunchAgents/         # System agents\n├── Receipts/             # Install history\n└── Logs/                 # Application logs\n\n~/Library/\n├── LaunchAgents/         # User agents\n├── Keychains/            # User keychain\n├── Preferences/          # User settings\n└── Application Support/  # App data, TCC\n```\n\nSYSTEM ARTIFACTS CHECKLIST:\n```\nmacOS System Analysis:\n\n[ ] System Configuration\n    [ ] OS version documented\n    [ ] Network configuration\n    [ ] Installed software list\n    \n[ ] Security Settings\n    [ ] FileVault status\n    [ ] Gatekeeper settings\n    [ ] TCC permissions reviewed\n    [ ] Quarantine events extracted\n    \n[ ] Logs\n    [ ] Unified logs exported\n    [ ] Authentication events\n    [ ] Security events\n    \n[ ] Persistence\n    [ ] LaunchAgents/Daemons reviewed\n    [ ] Login items checked\n    [ ] Cron jobs examined\n```\n\nKEY FORENSIC IMPLICATIONS:\n- Unified logs provide extensive activity history\n- TCC database reveals privacy permission grants\n- Quarantine database tracks downloads\n- Persistence locations indicate compromise\n\nFURTHER READING:\n- Apple Security Guide\n- \"macOS Forensics\" courses by SANS\n- plutil and sqlite3 man pages",
      "tags": ["forensics", "macos", "artifacts", "logs", "dfir"],
      "related_tools": ["strings", "exiftool"]
    },
    {
      "id": "macos_user_artifacts",
      "title": "macOS User Activity Artifacts",
      "content": "OBJECTIVE: Extract and analyze user activity artifacts including browser data, application usage, and file access patterns on macOS.\n\nACADEMIC BACKGROUND:\nmacOS maintains extensive records of user activity through various databases, property lists, and logs. These artifacts reveal document access, browser history, application usage, Spotlight searches, and communication patterns. User artifacts are primarily stored in ~/Library.\n\nUSER ARTIFACTS:\n\n1. SPOTLIGHT AND RECENT ITEMS:\n   ```bash\n   # Spotlight Metadata:\n   ~/.Spotlight-V100/          # Volume-level index\n   ~/Library/Metadata/         # User metadata\n   \n   # Recent Items (System Preferences > General)\n   ~/Library/Application Support/com.apple.sharedfilelist/\n   ├── com.apple.LSSharedFileList.RecentDocuments.sfl2\n   ├── com.apple.LSSharedFileList.RecentApplications.sfl2\n   └── com.apple.LSSharedFileList.RecentServers.sfl2\n   \n   # Parse SFL files\n   # Use third-party tools as format is binary\n   \n   # Recent Folders (Finder Sidebar)\n   ~/Library/Application Support/com.apple.sharedfilelist/com.apple.LSSharedFileList.FavoriteItems.sfl2\n   \n   # Spotlight Shortcuts (saved searches)\n   ~/Library/Saved Searches/\n   \n   # mdfind queries from user (via terminal history)\n   cat ~/.zsh_history | grep mdfind\n   ```\n\n2. BROWSER ARTIFACTS:\n   ```bash\n   # Safari:\n   ~/Library/Safari/\n   ├── History.db              # Browsing history\n   ├── Downloads.plist         # Download history\n   ├── Bookmarks.plist         # Bookmarks\n   ├── TopSites.plist          # Frequently visited\n   ├── LastSession.plist       # Open tabs\n   └── CloudTabs.db            # iCloud synced tabs\n   \n   # Extract Safari history\n   sqlite3 ~/Library/Safari/History.db \\\n           \"SELECT datetime(visit_time + 978307200, 'unixepoch'), url \n            FROM history_visits \n            INNER JOIN history_items ON history_visits.history_item = history_items.id \n            ORDER BY visit_time DESC LIMIT 100;\"\n   \n   # Safari Downloads\n   plutil -p ~/Library/Safari/Downloads.plist\n   \n   # Chrome:\n   ~/Library/Application Support/Google/Chrome/Default/\n   ├── History                 # SQLite database\n   ├── Cookies                 # Cookies database\n   ├── Login Data              # Saved passwords\n   ├── Web Data                # Autofill data\n   └── Bookmarks               # JSON format\n   \n   # Extract Chrome history\n   sqlite3 ~/Library/Application\\ Support/Google/Chrome/Default/History \\\n           \"SELECT datetime(last_visit_time/1000000-11644473600,'unixepoch'), url, title \n            FROM urls ORDER BY last_visit_time DESC LIMIT 100;\"\n   \n   # Firefox:\n   ~/Library/Application Support/Firefox/Profiles/[profile]/\n   ├── places.sqlite           # History and bookmarks\n   ├── cookies.sqlite          # Cookies\n   ├── formhistory.sqlite      # Form data\n   └── logins.json             # Saved passwords\n   \n   # Extract Firefox history\n   sqlite3 ~/Library/Application\\ Support/Firefox/Profiles/*.default/places.sqlite \\\n           \"SELECT datetime(moz_historyvisits.visit_date/1000000,'unixepoch'), url \n            FROM moz_places, moz_historyvisits \n            WHERE moz_places.id = moz_historyvisits.place_id \n            ORDER BY visit_date DESC LIMIT 100;\"\n   ```\n\n3. EMAIL ARTIFACTS:\n   ```bash\n   # Apple Mail:\n   ~/Library/Mail/\n   ├── V10/                    # Mail database version\n   │   ├── [UUID]/             # Account folders\n   │   │   ├── INBOX.mbox/     # Mailbox\n   │   │   └── [folder].mbox/\n   │   └── MailData/\n   │       ├── Envelope Index  # SQLite index\n   │       └── Protected Index # Protected messages\n   └── Signatures/             # Email signatures\n   \n   # Analyze Mail envelope index\n   sqlite3 ~/Library/Mail/V*/MailData/Envelope\\ Index \\\n           \"SELECT datetime(date_sent), sender, subject \n            FROM messages ORDER BY date_sent DESC LIMIT 50;\"\n   \n   # Mail Attachments\n   ~/Library/Mail Downloads/\n   ~/Library/Containers/com.apple.mail/Data/Library/Mail Downloads/\n   \n   # Mail Preferences\n   ~/Library/Preferences/com.apple.mail.plist\n   # Contains account configuration, rules\n   ```\n\n4. MESSAGING ARTIFACTS:\n   ```bash\n   # Messages (iMessage/SMS):\n   ~/Library/Messages/\n   ├── chat.db                 # Main database\n   ├── chat.db-wal             # Write-ahead log\n   └── Attachments/            # Media files\n   \n   # Extract messages\n   sqlite3 ~/Library/Messages/chat.db \\\n           \"SELECT datetime(message.date/1000000000 + 978307200, 'unixepoch'), \n                   handle.id, message.text \n            FROM message \n            LEFT JOIN handle ON message.handle_id = handle.ROWID \n            ORDER BY message.date DESC LIMIT 100;\"\n   \n   # iMessage attachments\n   sqlite3 ~/Library/Messages/chat.db \\\n           \"SELECT datetime(message.date/1000000000 + 978307200, 'unixepoch'), \n                   attachment.filename, attachment.mime_type \n            FROM message \n            JOIN message_attachment_join ON message.ROWID = message_attachment_join.message_id \n            JOIN attachment ON attachment.ROWID = message_attachment_join.attachment_id;\"\n   \n   # FaceTime calls\n   ~/Library/Application Support/CallHistoryDB/CallHistory.storedata\n   sqlite3 ~/Library/Application\\ Support/CallHistoryDB/CallHistory.storedata \\\n           \"SELECT * FROM ZCALLRECORD;\"\n   ```\n\n5. APPLICATION USAGE:\n   ```bash\n   # Application Support Data:\n   ~/Library/Application Support/\n   # Contains per-app data, databases, caches\n   \n   # Dock Recent Applications\n   ~/Library/Preferences/com.apple.dock.plist\n   plutil -p ~/Library/Preferences/com.apple.dock.plist | grep -A5 \"recent-apps\"\n   \n   # Application Usage (Screen Time)\n   # Requires Full Disk Access\n   ~/Library/Application Support/Knowledge/knowledgeC.db\n   \n   # Extract app usage\n   sqlite3 ~/Library/Application\\ Support/Knowledge/knowledgeC.db \\\n           \"SELECT datetime(ZOBJECT.ZCREATIONDATE + 978307200, 'unixepoch'), \n                   ZOBJECT.ZVALUESTRING \n            FROM ZOBJECT \n            WHERE ZSTREAMNAME = '/app/inFocus' \n            ORDER BY ZCREATIONDATE DESC LIMIT 50;\"\n   \n   # Terminal History\n   ~/.bash_history\n   ~/.zsh_history\n   \n   # Parse zsh history with timestamps\n   cat ~/.zsh_history\n   # Format: : timestamp:0;command\n   ```\n\n6. CLOUD ARTIFACTS:\n   ```bash\n   # iCloud Drive:\n   ~/Library/Mobile Documents/\n   # Contains synced iCloud documents\n   \n   # iCloud metadata\n   ~/Library/Application Support/CloudDocs/\n   ├── session/\n   │   └── db/                 # Sync database\n   └── account/\n   \n   # iCloud Keychain sync\n   ~/Library/Keychains/[UUID]/\n   \n   # Dropbox:\n   ~/.dropbox/\n   ├── config.dbx             # Configuration\n   ├── host.dbx               # Device info\n   └── filecache.db           # File cache database\n   \n   ~/Dropbox/                  # Actual files\n   \n   # Google Drive:\n   ~/Library/Application Support/Google/Drive/\n   ~/Google Drive/             # or \"My Drive\"\n   \n   # OneDrive:\n   ~/Library/Containers/com.microsoft.OneDrive/Data/\n   ~/OneDrive/\n   ```\n\n7. DOCUMENT ACCESS:\n   ```bash\n   # File Provider (Documents in Cloud):\n   ~/Library/CloudStorage/\n   \n   # Preview app recent\n   ~/Library/Containers/com.apple.Preview/Data/Library/Preferences/\n   \n   # Document Versions\n   ~/.DocumentRevisions-V100/\n   # Contains automatic document saves\n   \n   # Autosave Information\n   ~/Library/Autosave Information/\n   \n   # Open/Save Panel History\n   ~/Library/Preferences/com.apple.finder.plist\n   # NSNavLastRootDirectory - last opened folder\n   \n   # USB Device History\n   /var/db/dslocal/nodes/Default/volumes/\n   # Or via system_profiler\n   system_profiler SPUSBDataType\n   \n   # Volume mounts (from unified log)\n   log show --predicate 'subsystem == \"com.apple.diskarbitration\"' --last 7d\n   ```\n\nUSER ARTIFACT LOCATIONS:\n```\nKey User Forensic Paths:\n\n~/Library/\n├── Safari/                  # Safari browser data\n├── Messages/                # iMessage/SMS\n├── Mail/                    # Apple Mail\n├── Preferences/             # App preferences\n├── Application Support/     # App data\n│   ├── Google/Chrome/       # Chrome browser\n│   ├── Firefox/             # Firefox browser\n│   ├── Knowledge/           # Screen Time\n│   └── com.apple.TCC/       # Privacy permissions\n├── Containers/              # Sandboxed apps\n├── Caches/                  # Application caches\n└── Logs/                    # Application logs\n\n~/\n├── .bash_history            # Bash command history\n├── .zsh_history             # Zsh command history\n├── Documents/               # User documents\n├── Downloads/               # Downloads folder\n└── Desktop/                 # Desktop items\n```\n\nUSER ARTIFACT CHECKLIST:\n```\nUser Activity Analysis:\n\n[ ] Browser Data\n    [ ] Safari history/downloads\n    [ ] Chrome history/downloads\n    [ ] Firefox history/downloads\n    [ ] Bookmarks extracted\n    \n[ ] Communications\n    [ ] Messages/iMessage\n    [ ] Email (Mail.app)\n    [ ] FaceTime calls\n    \n[ ] Application Usage\n    [ ] Recent applications\n    [ ] Terminal history\n    [ ] Screen Time data\n    \n[ ] File Access\n    [ ] Recent documents\n    [ ] USB device history\n    [ ] Cloud service artifacts\n    \n[ ] Cloud Data\n    [ ] iCloud Drive\n    [ ] Dropbox\n    [ ] Google Drive/OneDrive\n```\n\nKEY FORENSIC IMPLICATIONS:\n- SQLite databases contain rich activity history\n- iCloud sync spreads data across devices\n- Sandboxed apps store data in Containers\n- Timestamps in macOS epoch (2001-01-01)\n\nFURTHER READING:\n- \"Mac OS X Forensics\" by Jesse Spangenberger\n- SANS FOR518 course materials\n- sqlite3 forensics techniques",
      "tags": ["forensics", "macos", "user-activity", "browser", "dfir"],
      "related_tools": ["exiftool", "strings"]
    },
    {
      "id": "macos_malware_artifacts",
      "title": "macOS Malware and Intrusion Artifacts",
      "content": "OBJECTIVE: Identify indicators of compromise and malware artifacts specific to macOS systems including persistence mechanisms, privilege escalation, and defense evasion techniques.\n\nACADEMIC BACKGROUND:\nmacOS malware has evolved significantly with increased targeting of Apple systems. Attackers use macOS-specific persistence mechanisms, abuse legitimate system features, and attempt to bypass Gatekeeper and XProtect. Understanding these techniques is essential for effective incident response.\n\nMALWARE ANALYSIS:\n\n1. PERSISTENCE MECHANISMS:\n   ```bash\n   # Common Malware Persistence Locations:\n   \n   # Launch Agents/Daemons (most common)\n   ~/Library/LaunchAgents/                    # User agents\n   /Library/LaunchAgents/                     # System agents\n   /Library/LaunchDaemons/                    # System daemons\n   /System/Library/LaunchAgents/              # Apple agents\n   /System/Library/LaunchDaemons/             # Apple daemons\n   \n   # Check for suspicious entries\n   for dir in ~/Library/LaunchAgents /Library/Launch*; do\n       echo \"=== $dir ===\"\n       ls -la \"$dir\" 2>/dev/null\n   done\n   \n   # Analyze launch plist for malware indicators\n   plutil -p ~/Library/LaunchAgents/*.plist | grep -E \"Program|Arguments|RunAtLoad\"\n   \n   # Login Items (user-level persistence)\n   sfltool dumpbtm\n   # Or examine:\n   ~/Library/Application Support/com.apple.backgroundtaskmanagementagent/backgrounditems.btm\n   \n   # Kernel Extensions (rare, requires disable SIP)\n   /Library/Extensions/\n   /System/Library/Extensions/\n   kextstat | grep -v com.apple\n   \n   # System Extensions (modern alternative)\n   systemextensionsctl list\n   \n   # Cron Jobs\n   crontab -l\n   cat /etc/crontab\n   ls -la /var/at/tabs/\n   \n   # Periodic Scripts\n   ls -la /etc/periodic/daily/\n   ls -la /etc/periodic/weekly/\n   ls -la /etc/periodic/monthly/\n   \n   # At Jobs\n   atq\n   \n   # Profiles (MDM can be abused)\n   profiles list\n   profiles -P\n   \n   # dyld Environment Hijacking\n   env | grep DYLD\n   # Check for DYLD_INSERT_LIBRARIES\n   ```\n\n2. CODE SIGNATURE ANALYSIS:\n   ```bash\n   # Verify Code Signature\n   codesign -vv /Applications/SuspiciousApp.app\n   codesign -dvv /Applications/SuspiciousApp.app\n   \n   # Check signature details\n   codesign -d --verbose=4 /path/to/binary\n   \n   # Extract signing certificate\n   codesign -d --extract-certificates /path/to/binary\n   \n   # Check notarization status\n   spctl -a -vv /Applications/SuspiciousApp.app\n   \n   # Examine entitlements\n   codesign -d --entitlements - /path/to/binary\n   \n   # Common malware indicators:\n   # - ad-hoc signature (no Apple signature)\n   # - invalid signature\n   # - entitlements requesting unusual capabilities\n   # - signed but not notarized\n   \n   # Check if app is quarantined\n   xattr -l /path/to/app\n   # Look for: com.apple.quarantine\n   \n   # Gatekeeper assessment\n   spctl --assess --type exec /path/to/binary\n   ```\n\n3. XPROTECT AND MRT:\n   ```bash\n   # XProtect (Apple's malware signatures)\n   /Library/Apple/System/Library/CoreServices/XProtect.bundle/\n   \n   # View XProtect signatures\n   plutil -p /Library/Apple/System/Library/CoreServices/XProtect.bundle/Contents/Resources/XProtect.yara\n   \n   # MRT (Malware Removal Tool)\n   /Library/Apple/System/Library/CoreServices/MRT.app/\n   \n   # Check XProtect version\n   defaults read /Library/Apple/System/Library/CoreServices/XProtect.bundle/Contents/Info.plist CFBundleShortVersionString\n   \n   # XProtect logs\n   log show --predicate 'subsystem == \"com.apple.xprotect\"' --last 7d\n   \n   # Gatekeeper logs\n   log show --predicate 'subsystem == \"com.apple.syspolicy\"' --last 7d\n   ```\n\n4. PROCESS AND MEMORY ANALYSIS:\n   ```bash\n   # List running processes\n   ps aux\n   ps auxww  # Full command line\n   \n   # Process tree\n   pstree\n   \n   # Check for hidden processes\n   launchctl list\n   \n   # Network connections by process\n   lsof -i -P\n   netstat -anv\n   \n   # Open files by process\n   lsof -p [PID]\n   \n   # Process information\n   ps -p [PID] -o pid,ppid,user,command\n   \n   # Environment variables\n   ps eww -p [PID]\n   \n   # Memory dump (requires Debugging tool or root)\n   # Use tools like osxpmem or commercial tools\n   \n   # Suspicious process indicators:\n   # - Processes with no visible window but network activity\n   # - Processes spawned from /tmp, /var/tmp, ~/Library\n   # - Python/osascript/bash running from unusual locations\n   # - Processes impersonating system processes\n   ```\n\n5. NETWORK ARTIFACTS:\n   ```bash\n   # Current network connections\n   netstat -an | grep ESTABLISHED\n   lsof -i -P | grep ESTABLISHED\n   \n   # DNS cache\n   sudo dscacheutil -cachedump -entries DNS\n   \n   # Hosts file modification\n   cat /etc/hosts\n   \n   # Proxy configuration\n   scutil --proxy\n   \n   # Network logs\n   log show --predicate 'subsystem == \"com.apple.network\"' --last 1d\n   \n   # Firewall rules\n   sudo pfctl -sr\n   \n   # Check for unusual listeners\n   sudo lsof -iTCP -sTCP:LISTEN -P\n   \n   # Suspicious network indicators:\n   # - Connections to unusual ports\n   # - Beaconing patterns (regular intervals)\n   # - DNS queries to suspicious domains\n   # - Large data transfers to unknown IPs\n   ```\n\n6. FILE SYSTEM ARTIFACTS:\n   ```bash\n   # Suspicious file locations:\n   \n   # Temporary directories\n   ls -la /tmp/\n   ls -la /var/tmp/\n   ls -la /private/tmp/\n   \n   # Hidden files in user directories\n   ls -la ~/.*\n   find ~ -name \".*\" -type f 2>/dev/null\n   \n   # World-writable directories\n   find / -type d -perm -0002 2>/dev/null\n   \n   # Recently modified files\n   find / -mtime -1 -type f 2>/dev/null\n   find / -mmin -60 -type f 2>/dev/null\n   \n   # Files with suspicious extensions\n   find ~ -name \"*.py\" -o -name \"*.sh\" -o -name \"*.scpt\" 2>/dev/null\n   \n   # Examine extended attributes\n   xattr -lr /path/to/suspicious/directory\n   \n   # Check for ResourceForks (old hiding technique)\n   ls -la@ /path/to/file\n   \n   # Quarantine bypass attempts\n   log show --predicate 'eventMessage CONTAINS \"quarantine\"' --last 7d\n   ```\n\n7. COMMON MACOS MALWARE TTPS:\n   ```\n   MITRE ATT&CK - macOS Techniques:\n   \n   Initial Access:\n   - T1566: Phishing with malicious DMG/PKG\n   - T1189: Drive-by compromise\n   \n   Execution:\n   - T1059.004: Unix Shell\n   - T1059.002: AppleScript\n   - T1059.006: Python\n   - T1204: User Execution (open malicious DMG)\n   \n   Persistence:\n   - T1543.001: Launch Agent\n   - T1543.004: Launch Daemon\n   - T1547.011: Login Items\n   - T1547.006: Kernel Modules (with SIP disabled)\n   \n   Privilege Escalation:\n   - T1548.004: Elevated Execution with Prompt\n   - T1068: Exploitation for Privilege Escalation\n   \n   Defense Evasion:\n   - T1553.001: Gatekeeper Bypass\n   - T1562.001: Disable/Modify Security Tools\n   - T1222.002: File Permissions Modification\n   - T1027: Obfuscated Files\n   \n   Credential Access:\n   - T1555.001: Keychain\n   - T1056.002: Input Capture\n   \n   Collection:\n   - T1113: Screen Capture\n   - T1115: Clipboard Data\n   - T1005: Data from Local System\n   ```\n\nMALWARE HUNTING CHECKLIST:\n```\nmacOS Malware Investigation:\n\n[ ] Persistence Analysis\n    [ ] Launch Agents/Daemons\n    [ ] Login Items\n    [ ] Cron jobs\n    [ ] Profiles/MDM\n    [ ] Kernel/System Extensions\n    \n[ ] Code Analysis\n    [ ] Signature verification\n    [ ] Notarization check\n    [ ] Entitlements review\n    [ ] Quarantine status\n    \n[ ] Process Analysis\n    [ ] Running processes reviewed\n    [ ] Network connections mapped\n    [ ] Open files examined\n    \n[ ] File System\n    [ ] Temp directories checked\n    [ ] Hidden files identified\n    [ ] Recent modifications\n    \n[ ] Security Tools\n    [ ] XProtect status\n    [ ] Gatekeeper status\n    [ ] SIP status (csrutil status)\n```\n\nKEY FORENSIC IMPLICATIONS:\n- Launch Agents/Daemons are primary persistence\n- Code signing provides integrity verification\n- XProtect/Gatekeeper logs show bypass attempts\n- TCC database reveals granted permissions\n\nFURTHER READING:\n- \"The Art of Mac Malware\" by Patrick Wardle\n- Objective-See blog and tools\n- MITRE ATT&CK for macOS",
      "tags": ["forensics", "macos", "malware", "incident-response", "dfir"],
      "related_tools": ["yara", "strings", "binwalk"]
    },
    {
      "id": "macos_forensic_tools",
      "title": "macOS Forensic Tools and Automation",
      "content": "OBJECTIVE: Master macOS forensic tools and develop automated collection/analysis workflows for efficient investigations.\n\nACADEMIC BACKGROUND:\nEffective macOS forensics requires specialized tools that understand APFS, macOS artifacts, and Apple-specific formats. Combining commercial tools with open-source utilities and custom scripts enables comprehensive analysis. Automation is essential for handling the volume of artifacts in modern investigations.\n\nFORENSIC TOOLS:\n\n1. ACQUISITION TOOLS:\n   ```bash\n   # Commercial Acquisition Tools:\n   # - Cellebrite UFED/Inspector\n   # - Magnet ACQUIRE\n   # - MacQuisition\n   # - Recon Imager\n   \n   # Open Source Acquisition:\n   \n   # dd (basic imaging)\n   sudo dd if=/dev/disk0 of=/path/to/image.raw bs=4M status=progress\n   \n   # dc3dd (forensic dd)\n   sudo dc3dd if=/dev/disk0 of=/path/to/image.raw hash=sha256 log=/path/to/log.txt\n   \n   # asr (Apple Software Restore)\n   sudo asr restore --source /dev/disk0 --target /path/to/image.dmg --erase\n   \n   # hdiutil (for DMG handling)\n   hdiutil create -srcdevice /dev/disk0 -format UDRW /path/to/image.dmg\n   \n   # Memory Acquisition:\n   # osxpmem (Rekall project)\n   sudo ./osxpmem -o /path/to/memory.aff4\n   \n   # Live Response:\n   # KAPE for Mac (commercial)\n   # OSX Collector\n   # AutoMacTC\n   ```\n\n2. ANALYSIS FRAMEWORKS:\n   ```bash\n   # AutoMacTC (Crowdstrike)\n   # https://github.com/CrowdStrike/automactc\n   \n   # Install dependencies\n   pip install -r requirements.txt\n   \n   # Run full collection\n   sudo python automactc.py -m all -o /output/dir/\n   \n   # Modules include:\n   # - autoruns (persistence)\n   # - bash_history\n   # - chrome_history\n   # - coreanalytics\n   # - firefox_history\n   # - installhistory\n   # - mru (Most Recently Used)\n   # - quarantines\n   # - safari_history\n   # - spotlight\n   # - systeminfo\n   # - users\n   # - utmpx (login records)\n   \n   # OSXCollector (Yelp)\n   # https://github.com/Yelp/osxcollector\n   \n   sudo python osxcollector.py -o /output/dir/\n   \n   # mac_apt (macOS Artifact Parsing Tool)\n   # https://github.com/ydkhatri/mac_apt\n   \n   python mac_apt.py -o /output/ -i /path/to/image/ UNIFIED_LOGS\n   python mac_apt.py -o /output/ -i /path/to/image/ -p ALL\n   # Plugins: AUTOSTART, BASHSESSIONS, CHROME, FIREFOX, etc.\n   ```\n\n3. SQLITE ANALYSIS:\n   ```bash\n   # SQLite is ubiquitous in macOS\n   \n   # Basic query\n   sqlite3 database.db \"SELECT * FROM table LIMIT 10;\"\n   \n   # Dump schema\n   sqlite3 database.db \".schema\"\n   \n   # Export to CSV\n   sqlite3 -header -csv database.db \"SELECT * FROM table;\" > output.csv\n   \n   # WAL analysis (deleted records)\n   # Copy both database and WAL file\n   cp database.db database.db-wal /analysis/\n   \n   # Force WAL checkpoint\n   sqlite3 database.db \"PRAGMA wal_checkpoint(TRUNCATE);\"\n   \n   # Analyze SQLite with DB Browser\n   # GUI tool for browsing SQLite databases\n   \n   # Python SQLite analysis\n   import sqlite3\n   conn = sqlite3.connect('database.db')\n   cursor = conn.cursor()\n   cursor.execute(\"SELECT * FROM messages\")\n   for row in cursor.fetchall():\n       print(row)\n   \n   # Recover deleted records\n   # Use undark or commercial tools\n   ```\n\n4. PLIST ANALYSIS:\n   ```bash\n   # Property List Formats:\n   # - Binary plist (most common)\n   # - XML plist\n   # - JSON plist\n   \n   # Convert binary to XML\n   plutil -convert xml1 file.plist\n   \n   # Convert to JSON\n   plutil -convert json file.plist\n   \n   # Pretty print plist\n   plutil -p file.plist\n   \n   # Using defaults command\n   defaults read /path/to/file.plist\n   \n   # Python plistlib\n   import plistlib\n   with open('file.plist', 'rb') as f:\n       data = plistlib.load(f)\n   print(data)\n   \n   # Extract specific key\n   plutil -extract key.path xml1 -o - file.plist\n   ```\n\n5. LOG ANALYSIS:\n   ```bash\n   # Unified Log Tools:\n   \n   # Built-in log command\n   log show --predicate 'process == \"sudo\"' --last 7d\n   \n   # Export to file\n   log show --archive /path/to/logarchive --output-format json > logs.json\n   \n   # Parse exported logs with jq\n   cat logs.json | jq '.[] | select(.processImagePath | contains(\"ssh\"))'\n   \n   # mac_apt for log analysis\n   python mac_apt.py -o /output/ -i /path/to/image/ UNIFIED_LOGS\n   \n   # Mandiant logGrab\n   # Extracts and analyzes unified logs\n   \n   # ASL (Apple System Log) - legacy\n   syslog -T local\n   \n   # Install Log Analysis Tools\n   # logParser\n   # Sumuri Passware (for encrypted logs)\n   ```\n\n6. CUSTOM COLLECTION SCRIPT:\n   ```bash\n   #!/bin/bash\n   # macOS Forensic Collection Script\n   \n   OUTPUT_DIR=\"/tmp/forensic_collection_$(date +%Y%m%d_%H%M%S)\"\n   mkdir -p \"$OUTPUT_DIR\"/{system,user,network,persistence,browser}\n   \n   echo \"[*] Starting macOS forensic collection...\"\n   \n   # System Information\n   echo \"[*] Collecting system information...\"\n   system_profiler SPSoftwareDataType > \"$OUTPUT_DIR/system/software.txt\"\n   system_profiler SPHardwareDataType > \"$OUTPUT_DIR/system/hardware.txt\"\n   sw_vers > \"$OUTPUT_DIR/system/version.txt\"\n   \n   # Network\n   echo \"[*] Collecting network information...\"\n   ifconfig -a > \"$OUTPUT_DIR/network/interfaces.txt\"\n   netstat -an > \"$OUTPUT_DIR/network/connections.txt\"\n   lsof -i > \"$OUTPUT_DIR/network/open_ports.txt\"\n   scutil --proxy > \"$OUTPUT_DIR/network/proxy.txt\"\n   \n   # Persistence\n   echo \"[*] Collecting persistence mechanisms...\"\n   ls -la /Library/LaunchDaemons/ > \"$OUTPUT_DIR/persistence/launch_daemons.txt\"\n   ls -la /Library/LaunchAgents/ > \"$OUTPUT_DIR/persistence/launch_agents_system.txt\"\n   ls -la ~/Library/LaunchAgents/ > \"$OUTPUT_DIR/persistence/launch_agents_user.txt\" 2>/dev/null\n   crontab -l > \"$OUTPUT_DIR/persistence/crontab.txt\" 2>/dev/null\n   sfltool dumpbtm > \"$OUTPUT_DIR/persistence/login_items.txt\" 2>/dev/null\n   \n   # User Data\n   echo \"[*] Collecting user artifacts...\"\n   cp ~/.bash_history \"$OUTPUT_DIR/user/\" 2>/dev/null\n   cp ~/.zsh_history \"$OUTPUT_DIR/user/\" 2>/dev/null\n   \n   # Browser (copy databases)\n   echo \"[*] Collecting browser data...\"\n   cp ~/Library/Safari/History.db \"$OUTPUT_DIR/browser/\" 2>/dev/null\n   cp -r ~/Library/Application\\ Support/Google/Chrome/Default/History \"$OUTPUT_DIR/browser/chrome_history\" 2>/dev/null\n   \n   # Logs\n   echo \"[*] Exporting logs...\"\n   log collect --output \"$OUTPUT_DIR/system/unified_logs.logarchive\" --last 7d 2>/dev/null\n   \n   # Create hash manifest\n   echo \"[*] Creating hash manifest...\"\n   find \"$OUTPUT_DIR\" -type f -exec shasum -a 256 {} \\; > \"$OUTPUT_DIR/manifest_sha256.txt\"\n   \n   # Compress\n   echo \"[*] Compressing collection...\"\n   tar -czvf \"${OUTPUT_DIR}.tar.gz\" -C /tmp \"$(basename $OUTPUT_DIR)\"\n   \n   echo \"[+] Collection complete: ${OUTPUT_DIR}.tar.gz\"\n   ```\n\n7. TIMELINE ANALYSIS:\n   ```bash\n   # Plaso (Log2Timeline)\n   # https://github.com/log2timeline/plaso\n   \n   # Extract timeline from image\n   log2timeline.py --storage-file timeline.plaso /path/to/image/\n   \n   # Generate CSV timeline\n   psort.py --output_format dynamic -w timeline.csv timeline.plaso\n   \n   # Filter timeline\n   psort.py -w filtered.csv timeline.plaso \"date > '2024-03-01' AND date < '2024-03-15'\"\n   \n   # Timesketch (web-based timeline analysis)\n   # Import plaso files for collaborative analysis\n   \n   # Manual timeline creation\n   # Combine artifacts with timestamps\n   # - File system timestamps\n   # - Log entries\n   # - Database records\n   # - Browser history\n   \n   # mactime format (TSK)\n   mactime -b bodyfile.txt -d > timeline.csv\n   ```\n\nTOOL REFERENCE:\n```\nmacOS Forensic Tool Summary:\n\nAcquisition:\n| Tool | Type | Use Case |\n|------|------|----------|\n| dd/dc3dd | Open Source | Raw imaging |\n| osxpmem | Open Source | Memory capture |\n| MacQuisition | Commercial | Full acquisition |\n| Cellebrite | Commercial | Mobile + Mac |\n\nAnalysis:\n| Tool | Type | Use Case |\n|------|------|----------|\n| AutoMacTC | Open Source | Artifact collection |\n| mac_apt | Open Source | Artifact parsing |\n| Autopsy | Open Source | Full analysis |\n| Recon ITR | Commercial | Comprehensive |\n\nLog Analysis:\n| Tool | Type | Use Case |\n|------|------|----------|\n| log (built-in) | Apple | Unified logs |\n| Plaso | Open Source | Timeline creation |\n| mac_apt | Open Source | Log parsing |\n\nDatabase:\n| Tool | Type | Use Case |\n|------|------|----------|\n| sqlite3 | Built-in | SQLite analysis |\n| DB Browser | Open Source | GUI SQLite |\n| undark | Open Source | Deleted recovery |\n```\n\nTOOL CHECKLIST:\n```\nmacOS Forensic Toolkit:\n\n[ ] Acquisition\n    [ ] Imaging tool ready\n    [ ] Memory capture tool\n    [ ] Live response tools\n    \n[ ] Analysis\n    [ ] AutoMacTC/mac_apt\n    [ ] SQLite tools\n    [ ] Plist utilities\n    \n[ ] Timeline\n    [ ] Plaso installed\n    [ ] Timeline template ready\n    \n[ ] Automation\n    [ ] Collection scripts\n    [ ] Analysis scripts\n    [ ] Reporting templates\n```\n\nKEY FORENSIC IMPLICATIONS:\n- Tool selection depends on case requirements\n- Combine automated and manual analysis\n- Document tool versions and hashes\n- Validate findings across multiple sources\n\nFURTHER READING:\n- Objective-See tools (free macOS security tools)\n- SANS FOR518 course\n- mac_apt documentation",
      "tags": ["forensics", "macos", "tools", "automation", "dfir"],
      "related_tools": ["strings", "exiftool", "binwalk", "foremost"]
    }
  ]
}
