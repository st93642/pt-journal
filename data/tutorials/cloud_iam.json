{
  "id": "cloud_iam",
  "title": "Cloud IAM Abuse 101",
  "description": "Cloud IAM Abuse 101 tutorial phase covering IAM fundamentals and privilege escalation patterns",
  "type": "tutorial",
  "steps": [
    {
      "id": "cloud-iam-fundamentals",
      "title": "Cloud IAM Fundamentals",
      "content": "OBJECTIVE: Understand cloud Identity and Access Management (IAM) principles and identify common privilege escalation patterns across AWS, Azure, and GCP.\n\nACADEMIC BACKGROUND:\nCloud IAM systems control access to resources through policies that define who can perform which actions on what resources. According to MITRE ATT&CK Cloud Matrix, privilege escalation via IAM misconfigurations is one of the most common cloud attack vectors (T1078 - Valid Accounts, T1548 - Abuse Elevation Control Mechanism).\n\nThe principle of least privilege is often violated in cloud environments due to:\n- Over-permissive wildcard policies (Resource: *, Action: *)\n- Misuse of administrative roles for routine tasks\n- Lack of conditional access controls (MFA, IP restrictions)\n- Excessive trust relationships between accounts/subscriptions\n\nSTEP-BY-STEP PROCESS:\n\n1. IAM FUNDAMENTALS BY CLOUD PROVIDER:\n\n   a) AWS IAM Core Concepts:\n      - Users: Permanent identities with credentials\n      - Roles: Temporary credentials assumed by users/services\n      - Policies: JSON documents defining permissions\n      - Groups: Collections of users inheriting policies\n      - STS (Security Token Service): Issues temporary credentials\n      \n      Key Actions for Privilege Escalation:\n      - iam:PassRole → Pass privileged role to services (Lambda, EC2)\n      - iam:CreatePolicyVersion → Modify existing policies\n      - iam:AttachUserPolicy → Grant yourself new permissions\n      - sts:AssumeRole → Switch to more privileged role\n      - iam:PutUserPolicy → Add inline policy to user\n      \n      Example:\n      ```bash\n      # Enumerate your current permissions\n      aws iam get-user --profile audit\n      aws iam list-attached-user-policies --user-name analyst\n      \n      # List all roles and their trust relationships\n      aws iam list-roles | jq '.Roles[] | {Name: .RoleName, AssumeRolePolicyDocument}'\n      \n      # Check if you can assume a privileged role\n      aws sts assume-role --role-arn arn:aws:iam::123456789012:role/AdminRole --role-session-name test\n      ```\n\n   b) Azure IAM (RBAC) Core Concepts:\n      - Azure AD: Cloud-native identity provider\n      - Service Principals: Application identities\n      - Managed Identities: System/user-assigned identities for Azure resources\n      - Role Definitions: Sets of permissions (Owner, Contributor, Reader, custom)\n      - Role Assignments: Binds principals to roles at scopes (subscription, resource group, resource)\n      \n      Key Actions for Privilege Escalation:\n      - Microsoft.Authorization/roleAssignments/write → Grant roles\n      - Microsoft.Authorization/roleDefinitions/write → Create custom roles\n      - Microsoft.Compute/virtualMachines/extensions/write → Run code on VMs\n      - Microsoft.ManagedIdentity/userAssignedIdentities/assign/action → Assume identities\n      \n      Example:\n      ```bash\n      # Check your current identity and subscriptions\n      az account show\n      az account list --all\n      \n      # List role assignments for yourself\n      az role assignment list --assignee $(az ad signed-in-user show --query objectId -o tsv)\n      \n      # Search for high-privilege assignments\n      az role assignment list --all | jq '[.[] | select(.roleDefinitionName==\"Owner\")]'\n      ```\n\n   c) GCP IAM Core Concepts:\n      - Projects: Primary resource container and billing unit\n      - Service Accounts: Bot identities with keys\n      - Roles: Collections of permissions (primitive, predefined, custom)\n      - IAM Bindings: Attach members to roles at resource hierarchy (org, folder, project, resource)\n      \n      Key Actions for Privilege Escalation:\n      - iam.serviceAccounts.actAs → Impersonate service accounts\n      - iam.serviceAccountKeys.create → Create keys for privileged accounts\n      - resourcemanager.projects.setIamPolicy → Grant yourself owner\n      - iam.roles.update → Modify custom role permissions\n      \n      Example:\n      ```bash\n      # Check your current identity and projects\n      gcloud auth list\n      gcloud projects list\n      \n      # Get IAM policy for a project\n      gcloud projects get-iam-policy PROJECT_ID\n      \n      # Check service accounts you can impersonate\n      gcloud iam service-accounts list\n      ```\n\n2. DANGEROUS PERMISSION PATTERNS:\n\n   AWS Examples:\n   ```json\n   {\n     \"Effect\": \"Allow\",\n     \"Action\": \"*\",\n     \"Resource\": \"*\"\n   }\n   → Full administrative access\n   \n   {\n     \"Effect\": \"Allow\",\n     \"Action\": \"iam:PassRole\",\n     \"Resource\": \"*\"\n   }\n   → Can pass any role to services, potential for privilege escalation\n   \n   {\n     \"Effect\": \"Allow\",\n     \"Action\": \"sts:AssumeRole\",\n     \"Resource\": \"*\"\n   }\n   → Can assume any role without MFA or IP restrictions\n   ```\n\n   Azure Examples:\n   - Custom role with Microsoft.Authorization/* → Can manage all RBAC\n   - Owner at subscription scope → Full control including role assignments\n   - User Access Administrator → Can grant roles without resource permissions\n\n   GCP Examples:\n   - roles/owner at project level → Complete control\n   - iam.serviceAccountKeys.create + actAs → Create keys for privileged accounts\n   - Bindings with allUsers or allAuthenticatedUsers → Public access\n\n3. ENUMERATION METHODOLOGY:\n\n   AWS Reconnaissance:\n   ```bash\n   # Install ScoutSuite for multi-cloud auditing\n   pip install scoutsuite\n   scout aws --profile audit-profile\n   \n   # Or use Prowler for AWS-specific checks\n   prowler aws -f us-east-1\n   \n   # Manual enumeration\n   aws iam get-account-authorization-details > aws-iam-full.json\n   aws iam generate-credential-report\n   aws iam get-credential-report --decode > credential-report.csv\n   ```\n\n   Azure Reconnaissance:\n   ```bash\n   # Use AzureHound for AD enumeration\n   . ./azurehound.ps1\n   Invoke-AzureHound -Verbose\n   \n   # Or az CLI for targeted queries\n   az ad user list --query \"[].{UPN:userPrincipalName, ObjectId:objectId}\"\n   az role assignment list --all --include-inherited > azure-rbac.json\n   az ad sp list --all --query \"[].{DisplayName:displayName, AppId:appId}\"\n   ```\n\n   GCP Reconnaissance:\n   ```bash\n   # Enumerate projects and their IAM\n   for project in $(gcloud projects list --format=\"value(projectId)\"); do\n     echo \"Project: $project\"\n     gcloud projects get-iam-policy $project > iam_$project.json\n   done\n   \n   # List service accounts across projects\n   gcloud iam service-accounts list --project PROJECT_ID\n   ```\n\n4. PRIVILEGE ESCALATION PATHS:\n\n   Common Escalation Chains:\n   \n   a) AWS: Lambda Privilege Escalation\n      - User has iam:PassRole + lambda:CreateFunction\n      - Create Lambda with privileged role\n      - Execute Lambda to perform admin actions\n      \n   b) Azure: Managed Identity Abuse\n      - User has VM Contributor on a VM with Managed Identity\n      - Access VM metadata endpoint from within VM\n      - Obtain token for Managed Identity with higher privileges\n      \n   c) GCP: Service Account Key Creation\n      - User has iam.serviceAccountKeys.create on privileged SA\n      - Create key for service account with Owner role\n      - Authenticate as service account and gain full access\n\n5. LAB SCENARIO - Safe Privilege Escalation Testing:\n\n   Prerequisites:\n   - Isolated cloud account/project for testing\n   - Written authorization and documented test boundaries\n   - Audit logging enabled (CloudTrail, Azure Monitor, Cloud Logging)\n   - Ability to restore original state\n\n   Step-by-Step Lab:\n   \n   1. Setup:\n      ```bash\n      # AWS: Create test role with escalation path\n      aws iam create-role --role-name TestRole --assume-role-policy-document file://trust-policy.json\n      aws iam attach-role-policy --role-name TestRole --policy-arn arn:aws:iam::aws:policy/AdministratorAccess\n      \n      # Create analyst user with sts:AssumeRole\n      aws iam create-user --user-name test-analyst\n      aws iam attach-user-policy --user-name test-analyst --policy-arn arn:aws:iam::aws:policy/SecurityAudit\n      ```\n   \n   2. Enumerate from analyst perspective:\n      ```bash\n      aws iam list-roles --profile test-analyst > roles.json\n      jq '.Roles[] | select(.AssumeRolePolicyDocument | contains(\"test-analyst\"))' roles.json\n      ```\n   \n   3. Attempt escalation:\n      ```bash\n      aws sts assume-role --role-arn arn:aws:iam::ACCOUNT:role/TestRole --role-session-name PoC --profile test-analyst\n      # If successful, export credentials and test admin actions\n      ```\n   \n   4. Validate detection:\n      ```bash\n      aws cloudtrail lookup-events --lookup-attributes AttributeKey=Username,AttributeValue=test-analyst\n      # Confirm AssumeRole event was logged\n      ```\n   \n   5. Cleanup:\n      ```bash\n      aws iam delete-user --user-name test-analyst\n      aws iam delete-role --role-name TestRole\n      ```\n\n6. DETECTION AND DEFENSE:\n\n   Monitoring:\n   - AWS: CloudTrail for iam:*, sts:AssumeRole, policy modifications\n   - Azure: Azure AD Audit Logs for role assignments, PIM activations\n   - GCP: Cloud Logging for serviceAccount.keys.create, setIamPolicy\n   \n   Prevention:\n   - Enforce least privilege with regular access reviews\n   - Require MFA for sensitive operations (AWS IAM Conditions, Azure Conditional Access)\n   - Use SCPs/Azure Policies/Org Policies to deny dangerous actions\n   - Implement break-glass procedures for true emergencies\n   - Enable just-in-time access (AWS SSO, Azure PIM, GCP temporary grants)\n\nTOOLS AND RESOURCES:\n- ScoutSuite: Multi-cloud security auditing (https://github.com/nccgroup/ScoutSuite)\n- Prowler: AWS security assessment (https://github.com/prowler-cloud/prowler)\n- Pacu: AWS exploitation framework (https://github.com/RhinoSecurityLabs/pacu)\n- AzureHound: Azure AD enumeration for BloodHound (https://github.com/BloodHoundAD/AzureHound)\n- CloudSplaining: AWS IAM assessment (https://github.com/salesforce/cloudsplaining)\n- IAM-Viz: Visualize IAM policies (https://github.com/duo-labs/iamviz)\n\nREFERENCES:\n- Rhino Security Labs: AWS Privilege Escalation Methods (https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)\n- MITRE ATT&CK Cloud Matrix: (https://attack.mitre.org/matrices/enterprise/cloud/)\n- AWS IAM Security Best Practices: (https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)\n- Azure RBAC Best Practices: (https://learn.microsoft.com/azure/role-based-access-control/best-practices)\n- GCP IAM Security Guide: (https://cloud.google.com/iam/docs/using-iam-securely)\n\nFor hands-on lab instructions and automated tooling, refer to the 'cloud-iam-priv-esc-playbook' in the Tool Instructions panel.",
      "tags": [
        "cloud",
        "iam",
        "abuse"
      ],
      "related_tools": [
        "cloud-iam-priv-esc-playbook",
        "cloud-iam-enum",
        "aws-sam-cli",
        "workflow_cloud_security_assessment",
        "recon-ng"
      ]
    },
    {
      "id": "cloud-iam-security-quiz",
      "title": "Cloud IAM Security Quiz",
      "content": "Quiz content loaded from cloud_identity/cloud-iam-quiz.txt",
      "tags": [
        "quiz",
        "cloud",
        "iam"
      ],
      "related_tools": [
        "cloud-iam-priv-esc-playbook",
        "cloud-iam-enum",
        "workflow_cloud_security_assessment",
        "awscli",
        "cloudmapper"
      ]
    }
  ]
}