/// CompTIA PenTest+ PT0-003 quiz-based learning phase
///
/// This module provides 5 domains of CompTIA PenTest+ certification content:
/// - Domain 1.0: Engagement Management and Scoping (13%)
/// - Domain 2.0: Reconnaissance and Enumeration (21%)
/// - Domain 3.0: Vulnerability Discovery and Analysis (17%)
/// - Domain 4.0: Attacks and Exploits (35%)
/// - Domain 5.0: Post-exploitation and Lateral Movement (14%)
///
/// Questions are loaded from data/pentest/ directory structure.
use crate::model::{QuizStep, Step};
use crate::quiz::parse_question_file;
use std::fs;
use std::path::Path;
use uuid::Uuid;

/// Domain 1.0: Engagement Management and Scoping (13%)
pub const DOMAIN_1_ENGAGEMENT: &str = "1.0 Engagement Management and Scoping";

/// Domain 2.0: Reconnaissance and Enumeration (21%)
pub const DOMAIN_2_RECON: &str = "2.0 Reconnaissance and Enumeration";

/// Domain 3.0: Vulnerability Discovery and Analysis (17%)
pub const DOMAIN_3_VULNERABILITY: &str = "3.0 Vulnerability Discovery and Analysis";

/// Domain 4.0: Attacks and Exploits (35%)
pub const DOMAIN_4_ATTACKS: &str = "4.0 Attacks and Exploits";

/// Domain 5.0: Post-exploitation and Lateral Movement (14%)
pub const DOMAIN_5_POST_EXPLOIT: &str = "5.0 Post-exploitation and Lateral Movement";

/// Load questions from a file in the data directory
fn load_questions_from_file(
    relative_path: &str,
) -> Result<Vec<crate::model::QuizQuestion>, String> {
    let base_path = Path::new("data/pentest");
    let full_path = base_path.join(relative_path);

    // Check if file exists
    if !full_path.exists() {
        return Err(format!("Question file not found: {}", full_path.display()));
    }

    // Read file content
    let content = fs::read_to_string(&full_path).map_err(|e| {
        format!(
            "Failed to read question file {}: {}",
            full_path.display(),
            e
        )
    })?;

    // Parse questions
    parse_question_file(&content).map_err(|e| {
        format!(
            "Failed to parse questions from {}: {}",
            full_path.display(),
            e
        )
    })
}

/// Create a quiz step from a question file
fn create_quiz_step_from_file(
    title: String,
    domain: String,
    file_path: &str,
) -> Result<Step, String> {
    let questions = load_questions_from_file(file_path)?;

    if questions.is_empty() {
        return Err(format!("No questions loaded from {}", file_path));
    }

    let quiz_step = QuizStep::new(Uuid::new_v4(), title.clone(), domain, questions);

    Ok(Step::new_quiz(
        Uuid::new_v4(),
        title,
        vec![
            "quiz".to_string(),
            "pentest".to_string(),
            "pt0-003".to_string(),
        ],
        quiz_step,
    ))
}

/// Get all quiz steps for Domain 1.0 (Engagement Management and Scoping)
pub fn get_domain_1_steps() -> Vec<Step> {
    let mut steps = Vec::new();

    // 1.1 Pre-engagement Activities
    match create_quiz_step_from_file(
        "1.1 Pre-engagement Activities".to_string(),
        DOMAIN_1_ENGAGEMENT.to_string(),
        "1.0-engagement-management/1.1-pre-engagement.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 1.1: {}", e),
    }

    // 1.2 Collaboration and Communication
    match create_quiz_step_from_file(
        "1.2 Collaboration and Communication".to_string(),
        DOMAIN_1_ENGAGEMENT.to_string(),
        "1.0-engagement-management/1.2-collaboration-communication.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 1.2: {}", e),
    }

    // 1.3 Frameworks and Methodologies
    match create_quiz_step_from_file(
        "1.3 Frameworks and Methodologies".to_string(),
        DOMAIN_1_ENGAGEMENT.to_string(),
        "1.0-engagement-management/1.3-frameworks-methodologies.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 1.3: {}", e),
    }

    // 1.4 Reports and Remediation
    match create_quiz_step_from_file(
        "1.4 Reports and Remediation".to_string(),
        DOMAIN_1_ENGAGEMENT.to_string(),
        "1.0-engagement-management/1.4-reports-remediation.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 1.4: {}", e),
    }

    steps
}

/// Get all quiz steps for Domain 2.0 (Reconnaissance and Enumeration)
pub fn get_domain_2_steps() -> Vec<Step> {
    let mut steps = Vec::new();

    // 2.1 Information Gathering
    match create_quiz_step_from_file(
        "2.1 Information Gathering".to_string(),
        DOMAIN_2_RECON.to_string(),
        "2.0-reconnaissance-enumeration/2.1-information-gathering.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 2.1: {}", e),
    }

    // 2.2 Enumeration Techniques
    match create_quiz_step_from_file(
        "2.2 Enumeration Techniques".to_string(),
        DOMAIN_2_RECON.to_string(),
        "2.0-reconnaissance-enumeration/2.2-enumeration-techniques.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 2.2: {}", e),
    }

    // 2.3 Scripting for Reconnaissance
    match create_quiz_step_from_file(
        "2.3 Scripting for Reconnaissance".to_string(),
        DOMAIN_2_RECON.to_string(),
        "2.0-reconnaissance-enumeration/2.3-scripting-reconnaissance.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 2.3: {}", e),
    }

    // 2.4 Reconnaissance Tools
    match create_quiz_step_from_file(
        "2.4 Reconnaissance Tools".to_string(),
        DOMAIN_2_RECON.to_string(),
        "2.0-reconnaissance-enumeration/2.4-tools.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 2.4: {}", e),
    }

    steps
}

/// Get all quiz steps for Domain 3.0 (Vulnerability Discovery and Analysis)
pub fn get_domain_3_steps() -> Vec<Step> {
    let mut steps = Vec::new();

    // 3.1 Discovery Techniques
    match create_quiz_step_from_file(
        "3.1 Discovery Techniques".to_string(),
        DOMAIN_3_VULNERABILITY.to_string(),
        "3.0-vulnerability-discovery/3.1-discovery-techniques.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 3.1: {}", e),
    }

    // 3.2 Analyzing Vulnerability Output
    match create_quiz_step_from_file(
        "3.2 Analyzing Vulnerability Output".to_string(),
        DOMAIN_3_VULNERABILITY.to_string(),
        "3.0-vulnerability-discovery/3.2-analyzing-output.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 3.2: {}", e),
    }

    // 3.3 Physical Security Testing
    match create_quiz_step_from_file(
        "3.3 Physical Security Testing".to_string(),
        DOMAIN_3_VULNERABILITY.to_string(),
        "3.0-vulnerability-discovery/3.3-physical-security.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 3.3: {}", e),
    }

    steps
}

/// Get all quiz steps for Domain 4.0 (Attacks and Exploits)
pub fn get_domain_4_steps() -> Vec<Step> {
    let mut steps = Vec::new();

    // 4.1 Network Attacks
    match create_quiz_step_from_file(
        "4.1 Network Attacks".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.1-network-attacks.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.1: {}", e),
    }

    // 4.2 Authentication Attacks
    match create_quiz_step_from_file(
        "4.2 Authentication Attacks".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.2-authentication-attacks.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.2: {}", e),
    }

    // 4.3 Host-based Attacks
    match create_quiz_step_from_file(
        "4.3 Host-based Attacks".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.3-host-based-attacks.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.3: {}", e),
    }

    // 4.4 Web Application Attacks
    match create_quiz_step_from_file(
        "4.4 Web Application Attacks".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.4-web-app-attacks.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.4: {}", e),
    }

    // 4.5 Cloud Attacks
    match create_quiz_step_from_file(
        "4.5 Cloud Attacks".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.5-cloud-attacks.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.5: {}", e),
    }

    // 4.6 Wireless Attacks
    match create_quiz_step_from_file(
        "4.6 Wireless Attacks".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.6-wireless-attacks.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.6: {}", e),
    }

    // 4.7 Social Engineering
    match create_quiz_step_from_file(
        "4.7 Social Engineering".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.7-social-engineering.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.7: {}", e),
    }

    // 4.8 Specialized Systems Attacks
    match create_quiz_step_from_file(
        "4.8 Specialized Systems Attacks".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.8-specialized-systems.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.8: {}", e),
    }

    // 4.9 Scripting and Automation
    match create_quiz_step_from_file(
        "4.9 Scripting and Automation".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.9-scripting-automation.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.9: {}", e),
    }

    // 4.10 IAM Enumeration Techniques
    match create_quiz_step_from_file(
        "4.10 IAM Enumeration Techniques".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.10-iam-enumeration.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.10: {}", e),
    }

    // 4.11 OAuth/OIDC Abuse Paths
    match create_quiz_step_from_file(
        "4.11 OAuth/OIDC Abuse Paths".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.11-oauth-oidc-abuse.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.11: {}", e),
    }

    // 4.12 Federation Pitfalls
    match create_quiz_step_from_file(
        "4.12 Federation Pitfalls".to_string(),
        DOMAIN_4_ATTACKS.to_string(),
        "4.0-attacks-exploits/4.12-federation-pitfalls.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 4.12: {}", e),
    }

    steps
}

/// Get all quiz steps for Domain 5.0 (Post-exploitation and Lateral Movement)
pub fn get_domain_5_steps() -> Vec<Step> {
    let mut steps = Vec::new();

    // 5.1 Persistence Mechanisms
    match create_quiz_step_from_file(
        "5.1 Persistence Mechanisms".to_string(),
        DOMAIN_5_POST_EXPLOIT.to_string(),
        "5.0-post-exploitation/5.1-persistence.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 5.1: {}", e),
    }

    // 5.2 Lateral Movement Techniques
    match create_quiz_step_from_file(
        "5.2 Lateral Movement Techniques".to_string(),
        DOMAIN_5_POST_EXPLOIT.to_string(),
        "5.0-post-exploitation/5.2-lateral-movement.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 5.2: {}", e),
    }

    // 5.3 Data Staging and Exfiltration
    match create_quiz_step_from_file(
        "5.3 Data Staging and Exfiltration".to_string(),
        DOMAIN_5_POST_EXPLOIT.to_string(),
        "5.0-post-exploitation/5.3-staging-exfiltration.txt",
    ) {
        Ok(step) => steps.push(step),
        Err(e) => eprintln!("Failed to load 5.3: {}", e),
    }

    steps
}

/// Get all PenTest+ quiz steps across all domains
pub fn get_all_pentest_steps() -> Vec<Step> {
    let mut all_steps = Vec::new();

    all_steps.extend(get_domain_1_steps());
    all_steps.extend(get_domain_2_steps());
    all_steps.extend(get_domain_3_steps());
    all_steps.extend(get_domain_4_steps());
    all_steps.extend(get_domain_5_steps());

    all_steps
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_domain_1_steps() {
        let steps = get_domain_1_steps();
        assert_eq!(steps.len(), 4, "Domain 1 should have 4 subdomains");
        assert_eq!(steps[0].title, "1.1 Pre-engagement Activities");
        assert_eq!(steps[1].title, "1.2 Collaboration and Communication");
        assert_eq!(steps[2].title, "1.3 Frameworks and Methodologies");
        assert_eq!(steps[3].title, "1.4 Reports and Remediation");
    }

    #[test]
    fn test_domain_2_steps() {
        let steps = get_domain_2_steps();
        assert_eq!(steps.len(), 4, "Domain 2 should have 4 subdomains");
        assert_eq!(steps[0].title, "2.1 Information Gathering");
        assert_eq!(steps[1].title, "2.2 Enumeration Techniques");
    }

    #[test]
    fn test_domain_3_steps() {
        let steps = get_domain_3_steps();
        assert_eq!(steps.len(), 3, "Domain 3 should have 3 subdomains");
    }

    #[test]
    fn test_domain_4_steps() {
        let steps = get_domain_4_steps();
        assert_eq!(steps.len(), 12, "Domain 4 should have 12 subdomains");
    }

    #[test]
    fn test_domain_5_steps() {
        let steps = get_domain_5_steps();
        assert_eq!(steps.len(), 3, "Domain 5 should have 3 subdomains");
    }

    #[test]
    fn test_load_questions_from_file_success() {
        let result = load_questions_from_file("1.0-engagement-management/1.1-pre-engagement.txt");
        assert!(result.is_ok(), "Should successfully load 1.1 questions");

        let questions = result.unwrap();
        assert_eq!(questions.len(), 50, "Should have 50 questions");
    }

    #[test]
    fn test_load_questions_from_nonexistent_file() {
        let result = load_questions_from_file("nonexistent/file.txt");
        assert!(result.is_err(), "Should fail for nonexistent file");
        assert!(result.unwrap_err().contains("not found"));
    }

    #[test]
    fn test_create_quiz_step_from_file() {
        let result = create_quiz_step_from_file(
            "Test Step".to_string(),
            DOMAIN_1_ENGAGEMENT.to_string(),
            "1.0-engagement-management/1.1-pre-engagement.txt",
        );

        assert!(result.is_ok(), "Should create quiz step successfully");

        let step = result.unwrap();
        assert_eq!(step.title, "Test Step");
        assert!(step.is_quiz());

        // Verify quiz content
        if let Some(quiz_step) = step.get_quiz_step() {
            assert_eq!(quiz_step.questions.len(), 50);
            assert_eq!(quiz_step.domain, DOMAIN_1_ENGAGEMENT);
        } else {
            panic!("Step should contain quiz data");
        }
    }

    #[test]
    fn test_get_all_pentest_steps() {
        let all_steps = get_all_pentest_steps();
        assert_eq!(
            all_steps.len(),
            26,
            "Should have 26 total steps across all domains"
        );
    }
}
