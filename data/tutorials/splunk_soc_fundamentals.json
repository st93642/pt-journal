{
  "id": "splunk_soc_fundamentals",
  "title": "Splunk SOC Fundamentals",
  "description": "Comprehensive guide to using Splunk for Security Operations Center (SOC) activities including SPL queries, detection rules, dashboards, alerts, and threat hunting.",
  "type": "tutorial",
  "steps": [
    {
      "id": "splunk_architecture_overview",
      "title": "Splunk Architecture & SOC Integration",
      "content": "## Splunk Architecture for SOC Operations\n\nSplunk is one of the most widely deployed SIEM platforms in enterprise SOCs. Understanding its architecture is essential for effective threat detection and incident response.\n\n### Core Components\n\n**1. Universal Forwarder (UF)**\n- Lightweight agent deployed on endpoints\n- Collects and forwards log data to indexers\n- Minimal resource footprint (~100MB RAM)\n\n**2. Heavy Forwarder (HF)**\n- Full Splunk instance for data parsing\n- Performs data transformation before indexing\n- Used for complex parsing or data routing\n\n**3. Indexer**\n- Stores and indexes incoming data\n- Processes search requests\n- Clustering for high availability\n\n**4. Search Head**\n- User interface for searches and dashboards\n- Distributes searches across indexers\n- Search Head Clustering (SHC) for HA\n\n### Data Flow in SOC\n\n```\n[Endpoints] → [Universal Forwarders] → [Heavy Forwarders] → [Indexers] → [Search Heads] → [SOC Analysts]\n```\n\n### Key SOC Data Sources\n\n| Source Type | Log Type | Use Case |\n|-------------|----------|----------|\n| Windows Event Logs | Security, System, Application | Authentication, Process execution |\n| Linux Syslog | auth.log, secure, audit | SSH, sudo, authentication |\n| Firewall Logs | Palo Alto, Fortinet, Cisco ASA | Network traffic, blocked connections |\n| Proxy Logs | Squid, Bluecoat, Zscaler | Web traffic analysis |\n| DNS Logs | Windows DNS, BIND, Infoblox | Domain lookups, C2 detection |\n| EDR Data | CrowdStrike, Carbon Black, Defender | Endpoint telemetry |\n\n### Splunk Enterprise Security (ES)\n\nSplunk ES is the premium SIEM solution built on Splunk:\n- **Notable Events** - Correlated security events\n- **Risk-Based Alerting** - Risk scores for entities\n- **Asset & Identity** - Context enrichment\n- **Threat Intelligence** - IOC matching\n- **Investigation Workbench** - Analyst workflows\n\n### License Considerations\n\nSplunk licensing is based on data volume:\n- Free license: 500MB/day, limited features\n- Enterprise: GB/day pricing\n- Splunk Cloud: Managed service pricing\n\nFor SOC operations, typical deployments range from 50GB to 500GB+ per day.",
      "tags": ["soc", "splunk", "siem", "architecture"],
      "related_tools": ["sigma"]
    },
    {
      "id": "spl_fundamentals",
      "title": "SPL (Search Processing Language) Fundamentals",
      "content": "## SPL - The Language of Splunk\n\nSPL (Search Processing Language) is the query language used in Splunk. Mastering SPL is essential for effective threat hunting and detection engineering.\n\n### Basic Search Structure\n\n```spl\nindex=<index_name> sourcetype=<source_type> <search_terms>\n| command1 field1 field2\n| command2 field3\n| ...\n```\n\n### Essential SPL Commands\n\n**1. Filtering Commands**\n\n```spl\n# Basic search\nindex=windows EventCode=4625\n\n# Time range\nindex=windows EventCode=4625 earliest=-24h latest=now\n\n# Field filtering\nindex=windows EventCode=4625 | where Account_Name!=\"SYSTEM\"\n\n# Search with wildcards\nindex=windows EventCode=4625 Account_Name=\"admin*\"\n```\n\n**2. Statistical Commands**\n\n```spl\n# Count events\nindex=windows EventCode=4625 | stats count by Account_Name\n\n# Count distinct values\nindex=firewall | stats dc(src_ip) as unique_sources by dest_ip\n\n# Time-based statistics\nindex=windows | timechart span=1h count by EventCode\n\n# Top values\nindex=proxy | top 10 url\n```\n\n**3. Transformation Commands**\n\n```spl\n# Rename fields\nindex=windows | rename Account_Name as user\n\n# Evaluate new fields\nindex=proxy | eval size_kb=bytes/1024\n\n# Extract fields with regex\nindex=web | rex field=_raw \"user=(?<username>\\w+)\"\n\n# Table output\nindex=windows | table _time, user, EventCode, ComputerName\n```\n\n**4. Lookup Commands**\n\n```spl\n# Enrich with lookup table\nindex=firewall | lookup geo_lookup ip as src_ip OUTPUT country, city\n\n# Input lookup\n| inputlookup threat_intel.csv | search threat_type=\"malware\"\n```\n\n### SOC-Focused SPL Patterns\n\n**Failed Login Detection**\n```spl\nindex=windows sourcetype=WinEventLog:Security EventCode=4625\n| stats count by Account_Name, Source_Network_Address\n| where count > 5\n| sort -count\n```\n\n**Lateral Movement Detection**\n```spl\nindex=windows EventCode=4624 Logon_Type=3\n| stats dc(ComputerName) as hosts_accessed by Account_Name\n| where hosts_accessed > 10\n```\n\n**Process Execution Analysis**\n```spl\nindex=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=1\n| stats count by ParentImage, Image, CommandLine\n| sort -count\n```\n\n### SPL Best Practices\n\n1. **Be specific early** - Filter by index and sourcetype first\n2. **Use time ranges** - Narrow searches with earliest/latest\n3. **Avoid wildcards at start** - `user=*admin` is slow\n4. **Use tstats for speed** - Pre-indexed fields are faster\n5. **Limit fields returned** - Use `table` or `fields` commands",
      "tags": ["soc", "splunk", "spl", "queries"],
      "related_tools": ["sigma"]
    },
    {
      "id": "splunk_detection_rules",
      "title": "Creating Detection Rules & Correlation Searches",
      "content": "## Detection Engineering in Splunk\n\nDetection rules in Splunk can be implemented as scheduled searches, correlation searches (in Splunk ES), or real-time alerts.\n\n### Anatomy of a Detection Rule\n\n```spl\n# Rule: Brute Force Authentication Attempt\nindex=windows sourcetype=WinEventLog:Security EventCode=4625\n| bucket _time span=5m\n| stats count as attempts by Account_Name, Source_Network_Address, _time\n| where attempts >= 10\n| eval severity=case(\n    attempts>=50, \"critical\",\n    attempts>=20, \"high\",\n    attempts>=10, \"medium\"\n)\n```\n\n### MITRE ATT&CK Mapped Detections\n\n**T1078 - Valid Accounts (Persistence)**\n```spl\nindex=windows EventCode=4720 OR EventCode=4722 OR EventCode=4738\n| eval action=case(\n    EventCode=4720, \"Account Created\",\n    EventCode=4722, \"Account Enabled\",\n    EventCode=4738, \"Account Modified\"\n)\n| table _time, Account_Name, action, Subject_Account_Name\n```\n\n**T1003 - OS Credential Dumping**\n```spl\nindex=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=10\n| where TargetImage LIKE \"%lsass.exe\"\n| where NOT SourceImage IN (\"C:\\\\Windows\\\\System32\\\\*\", \"C:\\\\Program Files\\\\*\")\n| table _time, SourceImage, TargetImage, GrantedAccess\n```\n\n**T1059.001 - PowerShell Execution**\n```spl\nindex=windows sourcetype=XmlWinEventLog:Microsoft-Windows-PowerShell/Operational EventCode=4104\n| rex field=ScriptBlockText \"(?i)(Invoke-Mimikatz|Invoke-Expression|IEX|DownloadString|EncodedCommand)\" \n| where match(ScriptBlockText, \"(?i)(Invoke-Mimikatz|IEX|DownloadString)\")\n| table _time, ComputerName, ScriptBlockText\n```\n\n**T1055 - Process Injection**\n```spl\nindex=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=8\n| where NOT SourceImage LIKE \"C:\\\\Windows\\\\System32\\\\%\"\n| stats count by SourceImage, TargetImage\n| sort -count\n```\n\n### Correlation Search Components (Splunk ES)\n\n1. **Search** - The SPL query\n2. **Time Range** - How far back to search\n3. **Schedule** - How often to run\n4. **Throttling** - Suppress duplicate alerts\n5. **Notable Event** - Create security incident\n6. **Risk Score** - Add to entity risk\n\n### Creating a Correlation Search\n\n```spl\n# Correlation Search: Multiple Failed Logins Followed by Success\nindex=windows sourcetype=WinEventLog:Security\n| transaction Account_Name maxspan=10m\n| where eventcount>5\n| search EventCode=4625 AND EventCode=4624\n| eval attack_type=\"Successful Brute Force\"\n| table _time, Account_Name, Source_Network_Address, attack_type\n```\n\n### Alert Actions\n\n- **Email** - Send notification to SOC team\n- **Webhook** - Trigger SOAR playbook\n- **Notable Event** - Create in Splunk ES\n- **Risk Scoring** - Add to entity risk\n- **Script** - Execute custom response\n\n### Detection Rule Testing\n\n1. Run search manually first\n2. Verify results match expected behavior\n3. Check for false positives in production data\n4. Tune thresholds based on environment\n5. Document rule logic and MITRE mapping",
      "tags": ["soc", "splunk", "detection", "correlation"],
      "related_tools": ["sigma", "yara"]
    },
    {
      "id": "splunk_dashboards_visualizations",
      "title": "SOC Dashboards & Visualizations",
      "content": "## Building Effective SOC Dashboards\n\nDashboards provide real-time visibility into security posture and enable rapid threat detection.\n\n### Essential SOC Dashboard Panels\n\n**1. Security Overview Dashboard**\n\n```xml\n<dashboard>\n  <label>SOC Security Overview</label>\n  <row>\n    <panel>\n      <title>Failed Logins (24h)</title>\n      <single>\n        <search>\n          <query>index=windows EventCode=4625 earliest=-24h | stats count</query>\n        </search>\n      </single>\n    </panel>\n    <panel>\n      <title>New User Accounts</title>\n      <single>\n        <search>\n          <query>index=windows EventCode=4720 earliest=-24h | stats count</query>\n        </search>\n      </single>\n    </panel>\n  </row>\n</dashboard>\n```\n\n**2. Authentication Monitoring**\n\n```spl\n# Failed logins over time\nindex=windows EventCode=4625\n| timechart span=1h count by Account_Name\n\n# Login sources map\nindex=windows EventCode=4624 OR EventCode=4625\n| iplocation Source_Network_Address\n| geostats count by EventCode\n```\n\n**3. Network Traffic Analysis**\n\n```spl\n# Top talkers\nindex=firewall action=allowed\n| stats sum(bytes) as total_bytes by src_ip\n| sort -total_bytes | head 20\n\n# Blocked connections by category\nindex=firewall action=blocked\n| stats count by category | sort -count\n```\n\n**4. Endpoint Security Panel**\n\n```spl\n# Process execution frequency\nindex=windows sourcetype=*sysmon* EventCode=1\n| stats count by Image\n| sort -count | head 50\n\n# Suspicious command lines\nindex=windows EventCode=1\n| search CommandLine=\"*powershell*\" OR CommandLine=\"*cmd*\"\n| stats count by CommandLine | sort -count\n```\n\n### Dashboard Best Practices\n\n1. **Performance** - Use `tstats` for faster searches\n2. **Time Pickers** - Allow analysts to adjust time ranges\n3. **Drilldowns** - Enable click-through investigation\n4. **Color Coding** - Red for critical, yellow for warning\n5. **Real-time vs Scheduled** - Balance freshness and performance\n\n### Creating Drilldown Searches\n\n```xml\n<drilldown>\n  <link target=\"_blank\">\n    /app/search/search?q=index=windows EventCode=4625 Account_Name=$click.value$\n  </link>\n</drilldown>\n```\n\n### SOC Metrics Dashboard\n\n```spl\n# Mean Time to Detect (MTTD)\nindex=notable\n| eval detection_time=strptime(detection_time, \"%Y-%m-%d %H:%M:%S\")\n| eval event_time=strptime(event_time, \"%Y-%m-%d %H:%M:%S\")\n| eval mttd=detection_time-event_time\n| stats avg(mttd) as avg_mttd\n\n# Alert Volume by Severity\nindex=notable\n| stats count by severity | sort -severity\n```\n\n### Investigation Workbench\n\nCreate investigation templates for common scenarios:\n- Phishing investigation\n- Malware infection\n- Data exfiltration\n- Insider threat\n- Lateral movement",
      "tags": ["soc", "splunk", "dashboards", "visualization"],
      "related_tools": ["sigma"]
    },
    {
      "id": "splunk_threat_hunting",
      "title": "Threat Hunting with Splunk",
      "content": "## Proactive Threat Hunting in Splunk\n\nThreat hunting is proactive security analysis to find threats that evade automated detection.\n\n### Hunting Hypothesis Framework\n\n1. **Form Hypothesis** - \"Attackers may be using PowerShell for data exfiltration\"\n2. **Identify Data Sources** - Windows PowerShell logs, Sysmon\n3. **Build Query** - SPL to find suspicious PowerShell activity\n4. **Analyze Results** - Look for anomalies\n5. **Document Findings** - Create new detections if needed\n\n### Hunting Queries by Technique\n\n**Reconnaissance Hunting**\n```spl\n# Internal network scanning\nindex=firewall\n| stats dc(dest_port) as ports_scanned, dc(dest_ip) as hosts_scanned by src_ip\n| where ports_scanned > 100 OR hosts_scanned > 50\n```\n\n**Persistence Hunting**\n```spl\n# Registry run key modifications\nindex=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=13\n| where TargetObject LIKE \"%\\\\Run\\\\%\" OR TargetObject LIKE \"%\\\\RunOnce\\\\%\"\n| table _time, ComputerName, Image, TargetObject, Details\n\n# Scheduled task creation\nindex=windows EventCode=4698\n| table _time, ComputerName, Task_Name, Task_Content\n```\n\n**Execution Hunting**\n```spl\n# LOLBins execution\nindex=windows EventCode=1\n| where match(Image, \"(?i)(certutil|mshta|regsvr32|rundll32|wscript|cscript)\\.exe$\")\n| where NOT match(ParentImage, \"(?i)svchost\\.exe$\")\n| stats count by Image, CommandLine, ParentImage\n```\n\n**Defense Evasion Hunting**\n```spl\n# Process hollowing indicators\nindex=windows EventCode=10\n| where GrantedAccess IN (\"0x1F0FFF\", \"0x1FFFFF\", \"0x143A\")\n| where NOT match(SourceImage, \"(?i)MsMpEng\\.exe|csrss\\.exe\")\n| table _time, SourceImage, TargetImage, GrantedAccess\n```\n\n**Lateral Movement Hunting**\n```spl\n# PsExec-style lateral movement\nindex=windows EventCode=1\n| where Image LIKE \"%\\\\PSEXESVC.exe\" OR Image LIKE \"%\\\\PSEXEC.exe\"\n| stats count by ComputerName, User, CommandLine\n\n# WMI remote execution\nindex=windows EventCode=1 ParentImage=\"*wmiprvse.exe\"\n| where NOT Image LIKE \"*WmiPrvSE.exe\"\n| table _time, ComputerName, User, Image, CommandLine\n```\n\n**Command and Control Hunting**\n```spl\n# Beaconing detection\nindex=proxy\n| bin _time span=60s\n| stats count by src_ip, dest, _time\n| streamstats current=f window=10 avg(count) as avg_count by src_ip, dest\n| where abs(count - avg_count) < 2\n| stats count as beacon_intervals by src_ip, dest\n| where beacon_intervals > 20\n```\n\n**Data Exfiltration Hunting**\n```spl\n# Large data transfers\nindex=proxy\n| stats sum(bytes_out) as total_out by src_ip, dest\n| where total_out > 100000000\n| sort -total_out\n\n# DNS tunneling indicators\nindex=dns\n| eval query_length=len(query)\n| where query_length > 50\n| stats count by query, src_ip\n| sort -count\n```\n\n### Hunting Workflow\n\n1. Schedule regular hunting sessions\n2. Document hypotheses and queries\n3. Track findings in case management\n4. Convert validated hunts to detections\n5. Share findings with team",
      "tags": ["soc", "splunk", "threat-hunting", "detection"],
      "related_tools": ["sigma", "yara"]
    },
    {
      "id": "splunk_incident_response",
      "title": "Incident Response & Investigation with Splunk",
      "content": "## SOC Incident Response Workflow\n\nSplunk serves as the central platform for incident investigation and response.\n\n### Investigation Workflow\n\n```\n[Alert Triggered] → [Triage] → [Investigation] → [Containment] → [Remediation] → [Lessons Learned]\n```\n\n### Triage Queries\n\n**Initial Alert Context**\n```spl\n# Get all events for an IP in last 24h\nindex=* src_ip=\"192.168.1.100\" OR dest_ip=\"192.168.1.100\"\n| stats count by index, sourcetype\n| sort -count\n```\n\n**User Activity Timeline**\n```spl\nindex=windows Account_Name=\"suspicious_user\"\n| table _time, EventCode, ComputerName, Message\n| sort _time\n```\n\n**Host Investigation**\n```spl\nindex=windows ComputerName=\"WORKSTATION01\"\n| timechart span=1h count by sourcetype\n```\n\n### Deep Dive Investigation\n\n**Process Tree Analysis**\n```spl\nindex=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=1\nComputerName=\"WORKSTATION01\"\n| table _time, Image, ParentImage, CommandLine, User\n| sort _time\n```\n\n**Network Connections for Host**\n```spl\nindex=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational EventCode=3\nComputerName=\"WORKSTATION01\"\n| table _time, Image, DestinationIp, DestinationPort, User\n| sort _time\n```\n\n**File System Activity**\n```spl\nindex=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\n(EventCode=11 OR EventCode=23 OR EventCode=26)\nComputerName=\"WORKSTATION01\"\n| table _time, EventCode, Image, TargetFilename\n| sort _time\n```\n\n### IOC Sweeping\n\n**Search for Malicious Hash**\n```spl\nindex=windows sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational\n(Hashes=\"*SHA256=<malicious_hash>*\" OR MD5=\"<malicious_hash>\")\n| table _time, ComputerName, Image, Hashes\n```\n\n**Search for Domain IOC**\n```spl\nindex=proxy dest=\"malicious-domain.com\" OR index=dns query=\"*malicious-domain.com*\"\n| table _time, src_ip, dest, url\n```\n\n**Search for IP IOC**\n```spl\nindex=* (src_ip=\"1.2.3.4\" OR dest_ip=\"1.2.3.4\" OR dest=\"1.2.3.4\")\n| stats count by index, sourcetype, src_ip, dest_ip\n```\n\n### Incident Documentation\n\n```spl\n# Export investigation results\nindex=windows ComputerName=\"WORKSTATION01\" earliest=-7d\n| table _time, sourcetype, EventCode, Message\n| outputcsv incident_12345_evidence.csv\n```\n\n### Response Actions via Splunk\n\n1. **Adaptive Response** (Splunk ES)\n   - Block IP at firewall\n   - Disable user account\n   - Isolate endpoint\n   - Create ticket in ServiceNow\n\n2. **Webhook Integration**\n   - Trigger SOAR playbook\n   - Send to Slack/Teams\n   - Update threat intel\n\n### Post-Incident Analysis\n\n```spl\n# Attack timeline visualization\nindex=* (src_ip=\"attacker_ip\" OR Account_Name=\"compromised_user\")\nearliest=\"2024-01-01T00:00:00\" latest=\"2024-01-02T00:00:00\"\n| eval event_type=sourcetype\n| timechart span=5m count by event_type\n```",
      "tags": ["soc", "splunk", "incident-response", "investigation"],
      "related_tools": ["sigma"]
    },
    {
      "id": "splunk_enterprise_security",
      "title": "Splunk Enterprise Security (ES) Deep Dive",
      "content": "## Splunk Enterprise Security Features\n\nSplunk ES is the premium SIEM solution providing advanced correlation, risk-based alerting, and investigation capabilities.\n\n### Key ES Components\n\n**1. Notable Events**\n- Security incidents requiring investigation\n- Created by correlation searches\n- Assigned to analysts for triage\n- Status workflow: New → In Progress → Resolved\n\n**2. Risk-Based Alerting (RBA)**\n\nRBA assigns risk scores to entities instead of generating immediate alerts:\n\n```spl\n# Add risk to user\n| sendalert risk param.risk_object=\"user@company.com\" \n  param.risk_object_type=\"user\" \n  param.risk_score=\"50\" \n  param.risk_message=\"Suspicious PowerShell execution\"\n```\n\n**Risk Score Aggregation**\n```spl\n| tstats summariesonly=true sum(All_Risk.calculated_risk_score) as total_risk \n  from datamodel=Risk \n  where All_Risk.risk_object_type=\"user\" \n  by All_Risk.risk_object\n| where total_risk > 100\n```\n\n**3. Asset & Identity Framework**\n\nEnrich events with context about users and systems:\n\n```spl\n# Lookup asset information\nindex=windows\n| lookup asset_lookup_by_str asset as ComputerName OUTPUT category, priority, owner\n```\n\n**4. Threat Intelligence Framework**\n\nMatch events against known IOCs:\n\n```spl\n# Check IP against threat intel\nindex=firewall\n| lookup threat_intel_ip ip as dest_ip OUTPUT threat_description, threat_category\n| where isnotnull(threat_description)\n```\n\n### ES Data Models\n\nPre-indexed data for fast searches:\n\n```spl\n# Authentication data model\n| tstats count from datamodel=Authentication \n  where Authentication.action=\"failure\" \n  by Authentication.user, Authentication.src\n\n# Network traffic data model\n| tstats sum(All_Traffic.bytes) as total_bytes \n  from datamodel=Network_Traffic \n  by All_Traffic.src_ip, All_Traffic.dest_ip\n```\n\n### ES Searches vs. Standard Splunk\n\n| Feature | Splunk Core | Splunk ES |\n|---------|-------------|----------|\n| Correlation | Manual | Built-in framework |\n| Risk Scoring | Custom | Native RBA |\n| Asset Context | Lookup tables | Asset & Identity |\n| Threat Intel | Manual | Integrated framework |\n| Case Management | External | Investigation workbench |\n\n### Creating ES Correlation Searches\n\n1. Navigate to **Configure → Content Management**\n2. Click **Create New Content → Correlation Search**\n3. Define:\n   - Search query (SPL)\n   - Time range and schedule\n   - Notable event settings\n   - Risk score contribution\n   - Adaptive response actions\n\n### ES Best Practices\n\n1. **Tune out false positives** - Use suppression lists\n2. **Leverage RBA** - Reduce alert fatigue\n3. **Maintain asset inventory** - Better context\n4. **Update threat intel** - Regular feed updates\n5. **Use data models** - Faster searches",
      "tags": ["soc", "splunk", "enterprise-security", "siem"],
      "related_tools": ["sigma"]
    },
    {
      "id": "splunk_spl_advanced",
      "title": "Advanced SPL Techniques",
      "content": "## Advanced SPL for SOC Analysts\n\nMaster these advanced SPL techniques for complex threat detection and analysis.\n\n### Transaction Analysis\n\nGroup related events into transactions:\n\n```spl\n# Track user session activity\nindex=proxy\n| transaction src_ip maxspan=30m maxpause=5m\n| stats count, sum(bytes) as total_bytes by src_ip\n| where count > 100\n```\n\n### Subsearches\n\nUse query results as input to another query:\n\n```spl\n# Find all activity from users with failed logins\nindex=windows EventCode=4624\n[search index=windows EventCode=4625 \n | stats count by Account_Name \n | where count > 5 \n | fields Account_Name]\n| stats count by Account_Name, ComputerName\n```\n\n### Join Operations\n\n```spl\n# Correlate authentication with process execution\nindex=windows EventCode=4624\n| join type=inner Account_Name \n  [search index=windows EventCode=1 \n   | rename User as Account_Name]\n| table _time, Account_Name, ComputerName, Image\n```\n\n### Macros for Reusability\n\n```spl\n# Define macro: suspicious_processes\n# Usage: `suspicious_processes`\nImage=\"*powershell.exe\" OR Image=\"*cmd.exe\" OR Image=\"*wscript.exe\"\n```\n\n### Statistical Anomaly Detection\n\n```spl\n# Standard deviation-based anomaly detection\nindex=proxy\n| timechart span=1h sum(bytes) as bytes by src_ip\n| eventstats avg(bytes) as avg_bytes, stdev(bytes) as stdev_bytes by src_ip\n| eval zscore=abs((bytes-avg_bytes)/stdev_bytes)\n| where zscore > 3\n```\n\n### Machine Learning Toolkit (MLTK)\n\n```spl\n# Train anomaly detection model\n| inputlookup network_baseline.csv\n| fit DensityFunction bytes by src_ip into network_anomaly_model\n\n# Apply model\nindex=proxy\n| apply network_anomaly_model\n| where isOutlier=1\n```\n\n### Acceleration Techniques\n\n**Using tstats (Accelerated Data Models)**\n```spl\n# Fast authentication search\n| tstats count from datamodel=Authentication \n  where Authentication.action=\"failure\" \n  by Authentication.user, Authentication.src, _time span=1h\n```\n\n**Summary Indexing**\n```spl\n# Create summary index\nindex=windows EventCode=4625\n| stats count by Account_Name, Source_Network_Address\n| collect index=summary_auth_failures\n```\n\n### Complex Detection Patterns\n\n**Multi-Stage Attack Detection**\n```spl\nindex=windows\n| eval stage=case(\n    EventCode=4625, \"1_recon\",\n    EventCode=4624 AND Logon_Type=3, \"2_access\",\n    EventCode=1 AND Image LIKE \"%powershell%\", \"3_execution\",\n    EventCode=3 AND DestinationPort IN (443, 80), \"4_c2\"\n)\n| where isnotnull(stage)\n| transaction Account_Name maxspan=1h\n| where match(stage, \"1_recon.*2_access.*3_execution\")\n```\n\n**Behavioral Baseline Deviation**\n```spl\nindex=proxy\n| bucket _time span=1d\n| stats dc(dest) as unique_domains by src_ip, _time\n| eventstats avg(unique_domains) as avg_domains, stdev(unique_domains) as std_domains by src_ip\n| eval deviation=(unique_domains-avg_domains)/std_domains\n| where deviation > 2\n```",
      "tags": ["soc", "splunk", "spl", "advanced"],
      "related_tools": ["sigma"]
    }
  ]
}
